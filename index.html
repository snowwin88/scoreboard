<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¹²çªçœ¼è®¡åˆ†å™¨</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #f5f5f5;
    }

    .container {
      width: 100%;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin-bottom: 12px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 16px;
      margin-bottom: 16px;
      box-sizing: border-box;
    }

    .player-count-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
      color: #333;
    }
    .player-count-buttons {
      display: flex;
      gap: 6px;
    }
    .btn-small {
      width: 32px;
      padding: 2px 0;
      font-size: 14px;
      background: #e0e0e0;
      color: #333;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .players-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .player-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 0 4px 8px;
      box-sizing: border-box;
      position: relative;
    }

    .name-select {
      width: 100%;
      padding: 4px 6px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #aaa;
      box-sizing: border-box;
      background: #fff;
    }

    .name-input {
      width: 100%;
      padding: 4px 6px;
      font-size: 15px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid #aaa;
      box-sizing: border-box;
    }

    .score-row {
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }

    .score-input {
      width: 100%;
      padding: 6px 4px;
      font-size: 18px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      background: #fff;
    }

    .score-input-active {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
    }

    .score-input-locked {
      background: #eeeeee;
      color: #999999;
      border-color: #cccccc;
    }

    button {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      background: #007aff;
      color: white;
      cursor: pointer;
      box-sizing: border-box;
    }

    button:disabled {
      background: #bbb;
      color: #666;
      cursor: default;
    }

    .table-action-btn {
      width: auto;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
      margin: 0 2px;
    }

    .confirmed {
      background: #f0f0f0;
      font-weight: bold;
      border-color: #bbb;
    }

    .sum {
      font-size: 15px;
      font-weight: 600;
      text-align: center;
      margin-top: 8px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-save {
      background: #34c759;
    }
    .btn-reset {
      background: #e0e0e0;
      color: #333;
    }

    .totals {
      margin-top: 10px;
    }

    .history {
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    th, td {
      border: 1px solid #eee;
      padding: 4px;
      text-align: center;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }

    #summaryRow td {
      background: #fff5cc;
      font-weight: 700;
      color: #333;
      height: 26px;
    }

    .leader-cell {
      background: #ffe08a !important;
      color: #c62828;
    }
    .leader-text {
      color: #c62828;
      font-weight: 700;
    }

    .btn-export {
      margin-top: 8px;
      background: #4b7bec;
    }

    .hint {
      margin-top: 4px;
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    /* ===== æ€»åˆ†æ±‡æ€»ï¼šæ¨ªå‘æ’å + å¤§å·åˆ†æ•° ===== */
    .totals-title {
      font-size: 14px;
      margin-bottom: 4px;
      color: #111827;
    }

    .totals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .total-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 10px;
      background: #f3f4f6;
    }

    .rank-badge {
      display: inline-block;
      min-width: 32px;
      text-align: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #facc15;
      color: #111827;
      font-weight: 700;
      font-size: 14px;
    }

    .leader-rank {
      background: #f97316;
      color: #ffffff;
    }

    .player-name {
      font-size: 14px;
      min-width: 60px;
    }

    .player-score {
      font-size: 32px;
      font-weight: 800;
      color: #111827;
    }
    .player-score-positive {
      color: #16a34a;
    }
    .player-score-negative {
      color: #dc2626;
    }
    .player-score-zero {
      color: #4b5563;
    }
    .leader-score {
      text-shadow: 0 0 3px rgba(198, 40, 40, 0.4);
    }

    /* ===== è¶£å‘³ç»Ÿè®¡åŒºåŸŸ ===== */
    .stats-subtitle {
      font-size: 13px;
      font-weight: 600;
      margin: 6px 0;
      color: #111827;
    }

    .stats-flex {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
    }

    .stats-wins-list {
      font-size: 13px;
      line-height: 1.5;
      min-width: 140px;
      flex: 1;
    }

    .stats-list {
      margin: 4px 0;
      padding-left: 18px;
    }

    .stats-list li {
      margin: 2px 0;
    }

    .stats-maxmin {
      font-size: 13px;
      line-height: 1.5;
    }

    /* ===== è‡ªå®šä¹‰æ•°å­—é”®ç›˜ ===== */
    .keypad-overlay {
      position: absolute;
      background: #1f2933;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 8px 10px 10px;
      box-sizing: border-box;
      z-index: 999;
      border-radius: 10px;
      display: none;
      min-width: 170px;
    }

    .keypad-title {
      font-size: 11px;
      color: #e5e7eb;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .keypad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }

    .keypad-btn {
      padding: 8px 0;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
    }

    .keypad-btn:active {
      background: #374151;
    }

    .keypad-row-bottom {
      display: grid;
      grid-template-columns: 1.5fr 1.5fr 2fr;
      gap: 6px;
      margin-top: 4px;
    }

    .keypad-btn-func {
      padding: 6px 0;
      font-size: 13px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #4b5563;
      color: #f9fafb;
    }

    .keypad-btn-func:active {
      background: #6b7280;
    }

    .keypad-btn-ok {
      background: #10b981;
      color: #fff;
      font-weight: 600;
    }

    .keypad-btn-ok:active {
      background: #059669;
    }

    /* ===== è¶‹åŠ¿å›¾ ===== */
    .trend-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .trend-container {
      margin-top: 6px;
    }

    .trend-legend {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
    }

    .trend-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trend-color-box {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>å¹²çªçœ¼è®¡åˆ†å™¨</h1>

    <!-- æœ¬å±€è¾“å…¥ -->
    <div class="card">

      <div class="player-count-row">
        <div>å½“å‰ç©å®¶äººæ•°ï¼š<span id="playerCountText">4</span></div>
        <div class="player-count-buttons">
          <button type="button" class="btn-small" onclick="changePlayerCount(-1)">ï¼</button>
          <button type="button" class="btn-small" onclick="changePlayerCount(1)">ï¼‹</button>
        </div>
      </div>

      <div id="playersRow" class="players-row"></div>

      <div id="sumText" class="sum">å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0</div>

      <div class="btn-row">
        <button class="btn-save" onclick="saveRound()">ä¿å­˜æœ¬å±€å¹¶å¼€å§‹ä¸‹ä¸€å±€</button>
        <button class="btn-reset" onclick="resetCurrentRound()">é‡ç½®æœ¬å±€</button>
        <button class="btn-reset" onclick="resetAll()">é‡ç½®æ•´åœº</button>
      </div>

      <div id="totalText" class="totals">
        å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰
      </div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="card">
      <div class="history">
        <strong>å†å²æ¯å±€åˆ†æ•°ï¼ˆæ€»è®¡åœ¨æœ€ä¸Šæ–¹ï¼Œæœ€æ–°ä¸€å±€åœ¨æ€»è®¡ä¸‹é¢ï¼‰</strong>
        <table>
          <thead>
            <tr id="historyHeaderRow"></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>

        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-export" id="historyToggleBtn"
                  onclick="toggleHistoryView()"
                  style="flex:0 0 auto; display:none;">
            æŸ¥çœ‹å…¨éƒ¨
          </button>
          <button class="btn-export" onclick="exportCSV()" style="flex:0 0 auto;">
            å¯¼å‡º CSVï¼ˆå…¨éƒ¨å±€ï¼‰
          </button>
        </div>
      </div>
    </div>

    <!-- æ€»åˆ†è¶‹åŠ¿å›¾ï¼ˆè‡ªé€‚åº”å®½åº¦ï¼‰ -->
    <div class="card">
      <div class="trend-title">æ€»åˆ†è¶‹åŠ¿å›¾ï¼ˆX è½´ï¼šå±€æ•°ï¼ŒY è½´ï¼šç´¯ç§¯æ€»åˆ†ï¼‰</div>
      <div class="trend-container">
        <!-- å…³é”®ï¼šä¸å†å†™æ­» widthï¼Œé«˜åº¦ç”¨ CSSï¼›å†…éƒ¨çœŸå®å°ºå¯¸ç”¨ JS åŠ¨æ€è®¾ç½® -->
        <canvas id="trendCanvas" style="width:100%; height:220px; display:block;"></canvas>
        <div id="trendLegend" class="trend-legend"></div>
      </div>
    </div>

    <!-- è¶£å‘³ç»Ÿè®¡ -->
    <div class="card">
      <strong>è¶£å‘³ç»Ÿè®¡</strong>

      <div class="stats-section" style="margin-top:6px;">
        <div class="stats-subtitle">1. èµ¢çš„æ¬¡æ•°ç»Ÿè®¡ï¼ˆå¾—åˆ†ä¸ºæ­£çš„å±€æ•°ï¼‰</div>
        <div class="stats-flex">
          <canvas id="statsPie" width="220" height="220" style="max-width:220px;"></canvas>
          <div id="statsWinsList" class="stats-wins-list">
            æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="stats-section" style="margin-top:10px;">
        <div class="stats-subtitle">2. å•å±€å¾—åˆ†çºªå½•</div>
        <div id="statsMaxMin" class="stats-maxmin">
          æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚
        </div>
      </div>
    </div>

    <!-- æç¤ºè¯´æ˜ -->
    <div class="card">
      <div class="hint">
        âœ¦ é»˜è®¤ 4 äººï¼Œå¯ä»¥é€šè¿‡ä¸Šæ–¹ã€Œï¼ / ï¼‹ã€è°ƒæ•´ 2ï½8 äººã€‚<br>
        âœ¦ å¯ä»¥ç›´æ¥ä½¿ç”¨é»˜è®¤åå­—ã€Œç©å®¶1~ç©å®¶Nã€ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸­æ–‡åå­—ã€‚<br>
        âœ¦ ç‚¹å‡»ç©å®¶åˆ†æ•°æ¡†è°ƒå‡ºè‡ªå®šä¹‰æ•°å­—é”®ç›˜ï¼Œé»˜è®¤è¾“å…¥ä¸ºè´Ÿæ•°ï¼Œå¦‚éœ€æ­£æ•°å¯ç‚¹å‡»ã€ŒÂ±ã€ã€‚<br>
        âœ¦ å½“æœ‰ Nâˆ’1 ä¸ªç©å®¶å·²ç»è¾“å…¥åˆ†æ•°åï¼Œæœ€åä¸€ä¸ªç©å®¶ä¼šè‡ªåŠ¨é”å®šï¼Œä¸èƒ½æ‰‹å·¥è¾“å…¥ï¼›<br>
        âœ¦ æ­¤æ—¶ç¬¬ Nâˆ’1 ä¸ªå®Œæˆè¾“å…¥çš„ç©å®¶æŒ‰é’®ä¼šå˜æˆã€Œç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰ã€ï¼Œå¯ä¸€é”®æäº¤æœ¬å±€ï¼›<br>
        âœ¦ ä»»æ„ Nâˆ’1 äººç¡®è®¤åï¼Œç¬¬ N äººè‡ªåŠ¨ç®—å‡ºï¼Œä¿è¯æœ¬å±€æ€»å’Œ = 0ã€‚<br>
        âœ¦ ã€Œé‡ç½®æœ¬å±€ã€åªæ¸…ç©ºå½“å‰å±€è¾“å…¥ï¼›ã€Œé‡ç½®æ•´åœºã€ä¼šæ¸…ç©ºæ‰€æœ‰å†å²ä¸æ€»åˆ†ã€‚<br>
      </div>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰æ•°å­—é”®ç›˜ -->
  <div id="customKeypad" class="keypad-overlay">
    <div class="keypad-title">
      <span>æ•°å­—é”®ç›˜</span>
      <button class="keypad-btn-func" style="width:auto;padding:2px 8px;font-size:11px;"
              onclick="closeKeypad()">æ”¶èµ·</button>
    </div>
    <div class="keypad-grid">
      <button class="keypad-btn" onclick="keypadAppend('7')">7</button>
      <button class="keypad-btn" onclick="keypadAppend('8')">8</button>
      <button class="keypad-btn" onclick="keypadAppend('9')">9</button>

      <button class="keypad-btn" onclick="keypadAppend('4')">4</button>
      <button class="keypad-btn" onclick="keypadAppend('5')">5</button>
      <button class="keypad-btn" onclick="keypadAppend('6')">6</button>

      <button class="keypad-btn" onclick="keypadAppend('1')">1</button>
      <button class="keypad-btn" onclick="keypadAppend('2')">2</button>
      <button class="keypad-btn" onclick="keypadAppend('3')">3</button>
    </div>
    <div class="keypad-grid" style="grid-template-columns: 1fr 1fr 1fr;">
      <button class="keypad-btn" onclick="toggleMinus()">Â±</button>
      <button class="keypad-btn" onclick="keypadAppend('0')">0</button>
      <button class="keypad-btn" onclick="keypadAppend('-')">-</button>
    </div>
    <div class="keypad-row-bottom">
      <button class="keypad-btn-func" onclick="keypadBackspace()">é€€æ ¼</button>
      <button class="keypad-btn-func" onclick="keypadClear()">æ¸…ç©º</button>
      <button class="keypad-btn-func keypad-btn-ok" onclick="closeKeypad()">å®Œæˆ</button>
    </div>
  </div>

  <script>
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (s) {
        switch (s) {
          case "&": return "&amp;";
          case "<": return "&lt;";
          case ">": return "&gt;";
          case '"': return "&quot;";
          case "'": return "&#39;";
          default: return s;
        }
      });
    }

    // ç”Ÿæˆå½“å‰æ—¶é—´å­—ç¬¦ä¸² YYYY-MM-DD HH:mm:ss
    function getCurrentTimestamp() {
      var d = new Date();
      function pad(n) { return n < 10 ? "0" + n : "" + n; }
      return d.getFullYear() + "-" +
             pad(d.getMonth() + 1) + "-" +
             pad(d.getDate()) + " " +
             pad(d.getHours()) + ":" +
             pad(d.getMinutes()) + ":" +
             pad(d.getSeconds());
    }

    // ===== é¢„å®šä¹‰é»˜è®¤äººå =====
    var defaultNames = [
      "JINHUA",
      "ZHOUKUN",
      "MAJIAN",
      "GUANGMING",
      "MINNA",
      "YA",
      "BETTY",
      "VINCENT",
      "CAIFANG"
    ];

    // ===== å…¨å±€çŠ¶æ€ =====
    var playerCount = 4;
    var nameInputs = [];
    var nameSelects = [];
    var scoreInputs = [];
    var confirmButtons = [];
    var scoreConfirmed = [];
    var scoreValues = [];
    var totalScores = [];
    var roundNumber = 0;

    // å†å²æ•°æ®ï¼šæ¯å±€åˆ†æ•° + æ—¶é—´
    var historyData = [];   // æ¯é¡¹ï¼šæ•°ç»„ [p1Score, p2Score, ...]
    var historyTimes = [];  // æ¯é¡¹ï¼šå­—ç¬¦ä¸²æ—¶é—´
    var editingIndex = null;

    var activeScoreIndex = null;
    var scoreInputLocked = [];
    var allConfirmIndex = null;

    // é¥¼å›¾ / è¶‹åŠ¿å›¾é¢œè‰²
    var pieColors = [
      "#f97316", "#3b82f6", "#10b981", "#e11d48",
      "#8b5cf6", "#0ea5e9", "#22c55e", "#facc15"
    ];

    // è¶‹åŠ¿å›¾å¯è§æ€§
    var trendVisible = [];

    // å†å²è®°å½•æ˜¾ç¤ºæ¨¡å¼ï¼šfalse = åªæ˜¾ç¤ºæœ€è¿‘10å±€ï¼›true = æ˜¾ç¤ºå…¨éƒ¨
    var showAllHistory = false;

    // ===== åˆå§‹åŒ– / é‡å»º UI & çŠ¶æ€ =====
    function initStateArrays() {
      scoreConfirmed = [];
      scoreValues = [];
      totalScores = [];
      scoreInputLocked = [];
      allConfirmIndex = null;
      for (var i = 0; i < playerCount; i++) {
        scoreConfirmed.push(false);
        scoreValues.push(0);
        totalScores.push(0);
        scoreInputLocked.push(false);
      }
      trendVisible = [];
      for (var j = 0; j < playerCount; j++) {
        trendVisible.push(true);
      }
    }

    function buildPlayersUI() {
      var row = document.getElementById("playersRow");
      row.innerHTML = "";
      nameInputs = [];
      nameSelects = [];
      scoreInputs = [];
      confirmButtons = [];

      for (var i = 0; i < playerCount; i++) {
        (function(index) {
          var col = document.createElement("div");
          col.className = "player-col";

          var sel = document.createElement("select");
          sel.className = "name-select";
          sel.id = "s" + (index + 1);
          col.appendChild(sel);

          var nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.id = "n" + (index + 1);
          nameInput.className = "name-input";
          nameInput.placeholder = "ç©å®¶" + (index + 1) + "ï¼ˆå¯ä¿®æ”¹ï¼‰";
          col.appendChild(nameInput);

          var scoreRow = document.createElement("div");
          scoreRow.className = "score-row";

          var scoreInput = document.createElement("input");
          scoreInput.type = "text";
          scoreInput.id = "p" + (index + 1);
          scoreInput.className = "score-input";
          scoreInput.placeholder = "0";
          scoreInput.readOnly = true;
          scoreInput.onclick = function() {
            openKeypad(index);
          };

          scoreRow.appendChild(scoreInput);
          col.appendChild(scoreRow);

          var btnConfirm = document.createElement("button");
          btnConfirm.id = "c" + (index + 1);
          btnConfirm.textContent = "ç¡®å®š";
          btnConfirm.onclick = function() { confirmPlayer(index); };
          col.appendChild(btnConfirm);

          row.appendChild(col);

          nameInputs.push(nameInput);
          nameSelects.push(sel);
          scoreInputs.push(scoreInput);
          confirmButtons.push(btnConfirm);

          sel.onchange = function() {
            if (sel.value) {
              nameInput.value = sel.value;
            }
            updateNameOptions();
            buildTrendLegend();
          };

          nameInput.addEventListener("input", buildTrendLegend);
        })(i);
      }

      updateNameOptions();
      refreshInputLockState();
      buildTrendLegend();
    }

    function updateNameOptions() {
      var used = {};
      for (var i = 0; i < nameSelects.length; i++) {
        var val = nameSelects[i].value;
        if (val) {
          used[val] = true;
        }
      }

      for (var j = 0; j < nameSelects.length; j++) {
        var sel = nameSelects[j];
        var current = sel.value;

        sel.innerHTML = "";
        var optEmpty = document.createElement("option");
        optEmpty.value = "";
        optEmpty.textContent = "é€‰æ‹©ç©å®¶â€¦";
        sel.appendChild(optEmpty);

        for (var k = 0; k < defaultNames.length; k++) {
          var name = defaultNames[k];
          if (used[name] && name !== current) continue;
          var opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }

        sel.value = current || "";
      }
    }

    function buildHistoryHeaderFooter() {
      var headerRow = document.getElementById("historyHeaderRow");
      var tbody = document.getElementById("historyBody");
      headerRow.innerHTML = "";
      tbody.innerHTML = "";

      var thRound = document.createElement("th");
      thRound.textContent = "å±€";
      headerRow.appendChild(thRound);

      var thTime = document.createElement("th");
      thTime.textContent = "æ—¶é—´";
      headerRow.appendChild(thTime);

      for (var i = 0; i < playerCount; i++) {
        var th = document.createElement("th");
        th.id = "h" + (i + 1);
        th.textContent = "ç©å®¶" + (i + 1);
        headerRow.appendChild(th);
      }

      var thEdit = document.createElement("th");
      thEdit.textContent = "ä¿®æ”¹";
      headerRow.appendChild(thEdit);

      var thDel = document.createElement("th");
      thDel.textContent = "åˆ é™¤";
      headerRow.appendChild(thDel);

      renderHistoryTable();
    }

    function updateHistoryToggleButton() {
      var btn = document.getElementById("historyToggleBtn");
      if (!btn) return;
      if (historyData.length > 10) {
        btn.style.display = "inline-block";
        btn.textContent = showAllHistory ? "åªçœ‹æœ€è¿‘10å±€" : "æŸ¥çœ‹å…¨éƒ¨";
      } else {
        btn.style.display = "none";
      }
    }

    function toggleHistoryView() {
      showAllHistory = !showAllHistory;
      renderHistoryTable();
    }

    function renderHistoryTable() {
      var tbody = document.getElementById("historyBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      var summaryRow = document.createElement("tr");
      summaryRow.id = "summaryRow";

      var tdLabel = document.createElement("td");
      tdLabel.textContent = "æ€»è®¡";
      summaryRow.appendChild(tdLabel);

      var tdTime = document.createElement("td");
      tdTime.textContent = "â€”";
      summaryRow.appendChild(tdTime);

      for (var j = 0; j < playerCount; j++) {
        var td = document.createElement("td");
        td.id = "t" + (j + 1);
        td.textContent = totalScores[j] || 0;
        summaryRow.appendChild(td);
      }

      var tdBlank1 = document.createElement("td");
      summaryRow.appendChild(tdBlank1);
      var tdBlank2 = document.createElement("td");
      summaryRow.appendChild(tdBlank2);

      tbody.appendChild(summaryRow);

      var totalRounds = historyData.length;
      var startIndex = 0;
      if (!showAllHistory && totalRounds > 10) {
        startIndex = totalRounds - 10;
      }

      for (var i = totalRounds - 1; i >= startIndex; i--) {
        (function(idx) {
          var tr = document.createElement("tr");

          var displayRound = idx + 1;
          var tdRound = document.createElement("td");
          tdRound.textContent = displayRound;
          tr.appendChild(tdRound);

          var tdTime2 = document.createElement("td");
          tdTime2.textContent = historyTimes[idx] || "";
          tr.appendChild(tdTime2);

          var scores = historyData[idx];
          for (var p = 0; p < playerCount; p++) {
            var tdScore = document.createElement("td");
            tdScore.textContent = scores[p];
            tr.appendChild(tdScore);
          }

          var tdEdit = document.createElement("td");
          var btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.textContent = "ä¿®æ”¹";
          btnEdit.className = "table-action-btn";
          btnEdit.onclick = function() { editRound(idx); };
          tdEdit.appendChild(btnEdit);
          tr.appendChild(tdEdit);

          var tdDel = document.createElement("td");
          var btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.textContent = "åˆ é™¤";
          btnDel.className = "table-action-btn";
          btnDel.onclick = function() { deleteRound(idx); };
          tdDel.appendChild(btnDel);
          tr.appendChild(tdDel);

          tbody.appendChild(tr);
        })(i);
      }

      updateHistoryToggleButton();
    }

    function recalcTotalsFromHistory() {
      for (var i = 0; i < playerCount; i++) {
        totalScores[i] = 0;
      }
      for (var r = 0; r < historyData.length; r++) {
        var scores = historyData[r];
        if (!scores) continue;
        for (var j = 0; j < playerCount; j++) {
          totalScores[j] += Number(scores[j] || 0);
        }
      }
    }

    function hasHistory() {
      return historyData.length > 0;
    }

    function anyConfirmed() {
      for (var i = 0; i < scoreConfirmed.length; i++) {
        if (scoreConfirmed[i]) return true;
      }
      return false;
    }

    function refreshInputLockState(changedIndex) {
      if (!scoreInputs || scoreInputs.length === 0) return;

      for (var i = 0; i < playerCount; i++) {
        if (!scoreConfirmed[i]) {
          scoreInputLocked[i] = false;
          if (scoreInputs[i]) {
            scoreInputs[i].classList.remove("score-input-locked");
          }
          if (confirmButtons[i]) {
            confirmButtons[i].disabled = false;
            confirmButtons[i].textContent = "ç¡®å®š";
          }
        }
      }
      allConfirmIndex = null;

      var filledCount = 0;
      var emptyIndices = [];
      for (var k = 0; k < playerCount; k++) {
        var v = (scoreInputs[k] && scoreInputs[k].value != null)
          ? scoreInputs[k].value.trim()
          : "";
        if (v !== "") {
          filledCount++;
        } else {
          emptyIndices.push(k);
        }
      }

      if (playerCount >= 2 &&
          filledCount >= playerCount - 1 &&
          emptyIndices.length === 1) {

        var lockedIdx = emptyIndices[0];

        if (!scoreConfirmed[lockedIdx]) {
          scoreInputLocked[lockedIdx] = true;
          if (scoreInputs[lockedIdx]) {
            scoreInputs[lockedIdx].classList.add("score-input-locked");
          }
          if (confirmButtons[lockedIdx]) {
            confirmButtons[lockedIdx].disabled = true;
          }
        }

        var candidate = null;

        if (typeof changedIndex === "number" &&
            changedIndex >= 0 &&
            changedIndex < playerCount &&
            !scoreConfirmed[changedIndex]) {

          var cv = (scoreInputs[changedIndex] && scoreInputs[changedIndex].value != null)
            ? scoreInputs[changedIndex].value.trim()
            : "";
          if (cv !== "" && changedIndex !== lockedIdx) {
            candidate = changedIndex;
          }
        }

        if (candidate === null &&
            allConfirmIndex !== null &&
            allConfirmIndex >= 0 &&
            allConfirmIndex < playerCount &&
            !scoreConfirmed[allConfirmIndex]) {
          var pv = (scoreInputs[allConfirmIndex] && scoreInputs[allConfirmIndex].value != null)
            ? scoreInputs[allConfirmIndex].value.trim()
            : "";
          if (pv !== "" && allConfirmIndex !== lockedIdx) {
            candidate = allConfirmIndex;
          }
        }

        if (candidate !== null && confirmButtons[candidate]) {
          allConfirmIndex = candidate;
          confirmButtons[candidate].textContent = "ç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰";
        }
      }
    }

    function changePlayerCount(delta) {
      var newCount = playerCount + delta;
      if (newCount < 2 || newCount > 8) {
        alert("ç©å®¶äººæ•°å¿…é¡»åœ¨ 2 åˆ° 8 äººä¹‹é—´ã€‚");
        return;
      }
      if (roundNumber > 0 || hasHistory() || anyConfirmed()) {
        alert("å¦‚éœ€æ›´æ”¹ç©å®¶äººæ•°ï¼Œè¯·å…ˆç‚¹å‡»ã€Œé‡ç½®æ•´åœºã€ã€‚");
        return;
      }

      playerCount = newCount;
      document.getElementById("playerCountText").textContent = playerCount;

      initStateArrays();
      buildPlayersUI();
      buildHistoryHeaderFooter();
      updateFooterTotals();
      refreshInputLockState();
      updateTotalsText();
      updateStatistics();
      resizeTrendCanvas();
      document.getElementById("sumText").innerHTML =
        "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
      document.getElementById("totalText").textContent =
        "å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰";
    }

    function confirmPlayer(i) {
      if (!confirmButtons[i]) return;

      if (confirmButtons[i].textContent === "ç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰") {
        confirmAllPlayers();
        return;
      }

      if (scoreConfirmed[i]) return;

      var rawName = nameInputs[i].value.trim();
      var defaultNameLabel = "ç©å®¶" + (i + 1);
      var displayName = rawName || defaultNameLabel;

      var sStr = scoreInputs[i].value;
      if (!sStr) {
        alert("è¯·å…ˆè¾“å…¥ã€Œ" + displayName + "ã€çš„åˆ†æ•°å†ç¡®å®šã€‚");
        return;
      }
      var s = Number(sStr);
      if (isNaN(s)) {
        alert("ç©å®¶ã€Œ" + displayName + "ã€çš„åˆ†æ•°å¿…é¡»æ˜¯æ•°å­—ã€‚");
        return;
      }

      nameInputs[i].readOnly = true;
      nameInputs[i].className = "name-input confirmed";
      if (nameSelects[i]) {
        nameSelects[i].disabled = true;
      }

      scoreConfirmed[i] = true;
      scoreValues[i] = s;
      scoreInputs[i].classList.remove("score-input-active");
      scoreInputs[i].classList.remove("score-input-locked");
      scoreInputs[i].className = "score-input confirmed";
      scoreInputLocked[i] = false;
      confirmButtons[i].disabled = true;

      refreshInputLockState();
      updateRound();
    }

    function confirmAllPlayers() {
      var sumOthers = 0;
      var lastIndex = -1;

      for (var i = 0; i < playerCount; i++) {
        var vStr = (scoreInputs[i] && scoreInputs[i].value != null)
          ? scoreInputs[i].value.trim()
          : "";

        if (scoreConfirmed[i]) {
          sumOthers += Number(scoreValues[i] || 0);
          continue;
        }

        if (vStr === "") {
          lastIndex = i;
          continue;
        }

        var v = Number(vStr);
        if (isNaN(v)) {
          alert("ç©å®¶ã€Œ" + (nameInputs[i].value.trim() || ("ç©å®¶" + (i+1))) + "ã€çš„åˆ†æ•°æ— æ•ˆã€‚");
          return;
        }

        scoreConfirmed[i] = true;
        scoreValues[i] = v;
        sumOthers += v;

        nameInputs[i].readOnly = true;
        nameInputs[i].className = "name-input confirmed";
        if (nameSelects[i]) {
          nameSelects[i].disabled = true;
        }

        scoreInputs[i].classList.remove("score-input-active");
        scoreInputs[i].classList.remove("score-input-locked");
        scoreInputs[i].className = "score-input confirmed";
        scoreInputLocked[i] = false;

        if (confirmButtons[i]) {
          confirmButtons[i].disabled = true;
          confirmButtons[i].textContent = "ç¡®å®š";
        }
      }

      if (lastIndex === -1) {
        updateRound();
        return;
      }

      var autoValue = -sumOthers;
      scoreConfirmed[lastIndex] = true;
      scoreValues[lastIndex] = autoValue;
      if (scoreInputs[lastIndex]) {
        scoreInputs[lastIndex].value = String(autoValue);
        scoreInputs[lastIndex].classList.remove("score-input-active");
        scoreInputs[lastIndex].classList.remove("score-input-locked");
        scoreInputs[lastIndex].className = "score-input confirmed";
      }
      scoreInputLocked[lastIndex] = false;

      nameInputs[lastIndex].readOnly = true;
      nameInputs[lastIndex].className = "name-input confirmed";
      if (nameSelects[lastIndex]) {
        nameSelects[lastIndex].disabled = true;
      }
      if (confirmButtons[lastIndex]) {
        confirmButtons[lastIndex].disabled = true;
        confirmButtons[lastIndex].textContent = "ç¡®å®š";
      }

      allConfirmIndex = null;
      refreshInputLockState();
      updateRound();
    }

    function updateRound() {
      var cnt = 0;
      var sum = 0;
      for (var i = 0; i < playerCount; i++) {
        if (scoreConfirmed[i]) {
          cnt++;
          sum += scoreValues[i];
        }
      }

      if (cnt === playerCount - 1) {
        var missing = -1;
        for (var j = 0; j < playerCount; j++) {
          if (!scoreConfirmed[j]) {
            missing = j;
            break;
          }
        }
        if (missing !== -1) {
          var autoValue = -sum;
          scoreConfirmed[missing] = true;
          scoreValues[missing] = autoValue;
          scoreInputs[missing].value = String(autoValue);
          scoreInputs[missing].classList.remove("score-input-active");
          scoreInputs[missing].classList.remove("score-input-locked");
          scoreInputs[missing].className = "score-input confirmed";
          scoreInputLocked[missing] = false;
          nameInputs[missing].readOnly = true;
          nameInputs[missing].className = "name-input confirmed";
          confirmButtons[missing].disabled = true;
          if (nameSelects[missing]) {
            nameSelects[missing].disabled = true;
          }
          cnt = playerCount;
          sum = 0;
        }
      }

      document.getElementById("sumText").innerHTML =
        "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š" + cnt + "ï¼Œæœ¬å±€æ€»å’Œï¼š" + sum;
    }

    function saveRound() {
      for (var i = 0; i < playerCount; i++) {
        if (!scoreConfirmed[i]) {
          alert("å¿…é¡»æ‰€æœ‰ç©å®¶éƒ½ç¡®è®¤æœ¬å±€æ‰èƒ½ä¿å­˜");
          return;
        }
      }

      var currentScores = [];
      for (var j = 0; j < playerCount; j++) {
        currentScores.push(scoreValues[j]);
      }

      if (editingIndex !== null && editingIndex >= 0 && editingIndex < historyData.length) {
        historyData[editingIndex] = currentScores;
        historyTimes[editingIndex] = getCurrentTimestamp();
      } else {
        historyData.push(currentScores);
        historyTimes.push(getCurrentTimestamp());
      }

      editingIndex = null;
      roundNumber = historyData.length;

      recalcTotalsFromHistory();
      renderHistoryTable();
      updateTotalsText();
      updateNamesInHistoryHeader();
      updateFooterTotals();
      updateStatistics();
      resizeTrendCanvas();

      for (var k = 0; k < playerCount; k++) {
        scoreConfirmed[k] = false;
        scoreValues[k] = 0;
        scoreInputLocked[k] = false;
        if (scoreInputs[k]) {
          scoreInputs[k].value = "";
          scoreInputs[k].className = "score-input";
        }
        if (confirmButtons[k]) {
          confirmButtons[k].disabled = false;
          confirmButtons[k].textContent = "ç¡®å®š";
        }

        nameInputs[k].readOnly = false;
        nameInputs[k].className = "name-input";
        if (nameSelects[k]) {
          nameSelects[k].disabled = false;
        }
      }

      allConfirmIndex = null;
      refreshInputLockState();
      document.getElementById("sumText").innerHTML =
        "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
    }

    function resetCurrentRound() {
      activeScoreIndex = null;
      allConfirmIndex = null;
      editingIndex = null;
      closeKeypad();

      for (var i = 0; i < playerCount; i++) {
        scoreConfirmed[i] = false;
        scoreValues[i] = 0;
        scoreInputLocked[i] = false;

        if (scoreInputs[i]) {
          scoreInputs[i].value = "";
          scoreInputs[i].className = "score-input";
        }
        if (confirmButtons[i]) {
          confirmButtons[i].disabled = false;
          confirmButtons[i].textContent = "ç¡®å®š";
        }

        nameInputs[i].readOnly = false;
        nameInputs[i].className = "name-input";
        if (nameSelects[i]) {
          nameSelects[i].disabled = false;
        }
      }

      refreshInputLockState();
      document.getElementById("sumText").innerHTML =
        "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
    }

    function editRound(index) {
      if (index < 0 || index >= historyData.length) return;

      if (anyConfirmed()) {
        if (!confirm("å½“å‰å±€æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç»§ç»­æ“ä½œä¼šè¦†ç›–è¿™äº›è¾“å…¥ï¼Œç¡®å®šè¦ç»§ç»­ä¿®æ”¹ç¬¬ " + (index + 1) + " å±€å—ï¼Ÿ")) {
          return;
        }
      }

      editingIndex = index;
      var scores = historyData[index];

      for (var i = 0; i < playerCount; i++) {
        scoreConfirmed[i] = false;
        scoreValues[i] = 0;
        scoreInputLocked[i] = false;

        if (scoreInputs[i]) {
          scoreInputs[i].value = scores[i];
          scoreInputs[i].className = "score-input";
        }
        if (confirmButtons[i]) {
          confirmButtons[i].disabled = false;
          confirmButtons[i].textContent = "ç¡®å®š";
        }

        nameInputs[i].readOnly = false;
        nameInputs[i].className = "name-input";
        if (nameSelects[i]) {
          nameSelects[i].disabled = false;
        }
      }

      allConfirmIndex = null;
      refreshInputLockState();
      document.getElementById("sumText").innerHTML =
        "æ­£åœ¨ä¿®æ”¹ç¬¬ " + (index + 1) + " å±€ï¼Œè¯·é‡æ–°ä¸ºæ¯ä½ç©å®¶ç‚¹å‡»ã€Œç¡®å®šã€ï¼Œå†ç‚¹ã€Œä¿å­˜æœ¬å±€å¹¶å¼€å§‹ä¸‹ä¸€å±€ã€ã€‚";
    }

    function deleteRound(index) {
      if (index < 0 || index >= historyData.length) return;
      if (!confirm("ç¡®å®šè¦åˆ é™¤ç¬¬ " + (index + 1) + " å±€çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
        return;
      }

      historyData.splice(index, 1);
      historyTimes.splice(index, 1);
      roundNumber = historyData.length;

      if (editingIndex === index) {
        editingIndex = null;
      } else if (editingIndex !== null && editingIndex > index) {
        editingIndex--;
      }

      recalcTotalsFromHistory();
      renderHistoryTable();
      updateFooterTotals();
      updateTotalsText();
      updateStatistics();
      resizeTrendCanvas();
    }

    function updateTotalsText() {
      var totalDiv = document.getElementById("totalText");

      if (historyData.length === 0) {
        totalDiv.innerHTML = "å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰";
        return;
      }

      var players = [];
      for (var i = 0; i < playerCount; i++) {
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var score = totalScores[i] || 0;
        players.push({
          index: i,
          name: name,
          score: score
        });
      }

      var max = Math.max.apply(null, totalScores);

      players.sort(function (a, b) {
        if (b.score !== a.score) {
          return b.score - a.score;
        }
        return a.index - b.index;
      });

      var html = '<div class="totals-title">å½“å‰æ€»åˆ†æ±‡æ€»ï¼ˆæŒ‰åˆ†æ•°ä»é«˜åˆ°ä½ï¼‰ï¼š</div>';
      html += '<div class="totals-row">';

      for (var j = 0; j < players.length; j++) {
        var p = players[j];
        var rank = j + 1;

        var rankCls = "rank-badge";
        var scoreCls = "player-score";

        if (p.score > 0) {
          scoreCls += " player-score-positive";
        } else if (p.score < 0) {
          scoreCls += " player-score-negative";
        } else {
          scoreCls += " player-score-zero";
        }

        var isLeader = (p.score === max && max !== 0);

        if (isLeader) {
          rankCls += " leader-rank";
          scoreCls += " leader-score";
        }

        var rankLabel = "#" + rank;
        if (isLeader) {
          rankLabel = "ğŸ‘‘" + rank;
        }

        html +=
          '<div class="total-item">' +
            '<span class="' + rankCls + '">' + rankLabel + '</span>' +
            '<span class="player-name">' + escapeHtml(p.name) + '</span>' +
            '<span class="' + scoreCls + '">' + p.score + '</span>' +
          '</div>';
      }

      html += '</div>';
      totalDiv.innerHTML = html;
    }

    function updateNamesInHistoryHeader() {
      for (var i = 0; i < playerCount; i++) {
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var cell = document.getElementById("h" + (i + 1));
        if (cell) cell.textContent = name;
      }
      buildTrendLegend();
    }

    function updateFooterTotals() {
      var max = Math.max.apply(null, totalScores);
      for (var i = 0; i < playerCount; i++) {
        var cell = document.getElementById("t" + (i + 1));
        if (!cell) continue;
        cell.textContent = totalScores[i];
        cell.classList.remove("leader-cell");
        if (totalScores[i] === max && max !== 0) {
          cell.classList.add("leader-cell");
        }
      }
    }

    // ===== è¶£å‘³ç»Ÿè®¡ï¼šèµ¢çš„æ¬¡æ•° + é¥¼å›¾ï¼ˆå¸¦ç©å®¶åã€ç™¾åˆ†æ¯”ã€æ€»æ¬¡æ•°ï¼‰ =====
    function updateStatistics() {
      var winsDiv = document.getElementById("statsWinsList");
      var maxMinDiv = document.getElementById("statsMaxMin");
      var canvas = document.getElementById("statsPie");
      if (!winsDiv || !maxMinDiv || !canvas) return;
      var ctx = canvas.getContext("2d");

      if (historyData.length === 0) {
        winsDiv.innerHTML = "æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚";
        maxMinDiv.innerHTML = "æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }

      var wins = [];
      for (var i = 0; i < playerCount; i++) {
        wins.push(0);
      }

      var maxScore = null, maxPlayerIndex = null, maxRound = null;
      var minScore = null, minPlayerIndex = null, minRound = null;

      for (var r = 0; r < historyData.length; r++) {
        var scores = historyData[r];
        if (!scores) continue;
        for (var p = 0; p < playerCount; p++) {
          var val = Number(scores[p] || 0);
          if (val > 0) {
            wins[p] += 1;
          }
          if (maxScore === null || val > maxScore) {
            maxScore = val;
            maxPlayerIndex = p;
            maxRound = r;
          }
          if (minScore === null || val < minScore) {
            minScore = val;
            minPlayerIndex = p;
            minRound = r;
          }
        }
      }

      var totalWins = wins.reduce(function(a, b) { return a + b; }, 0);

      var players = [];
      for (var j = 0; j < playerCount; j++) {
        var name = nameInputs[j].value.trim() || ("ç©å®¶" + (j + 1));
        players.push({
          index: j,
          name: name,
          wins: wins[j]
        });
      }

      players.sort(function(a, b) {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return a.index - b.index;
      });

      if (totalWins === 0) {
        winsDiv.innerHTML = "ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•ä¸€å±€ç©å®¶å¾—åˆ†ä¸ºæ­£ï¼Œç­‰å¾…æœ‰äººèµ¢ä¸€å±€å†æ¥çœ‹ç»Ÿè®¡å§ï½";
      } else {
        var listHtml = '<ul class="stats-list">';
        for (var k = 0; k < players.length; k++) {
          var pl = players[k];
          if (pl.wins === 0) continue;
          var rank = k + 1;
          var pct = totalWins > 0 ? (pl.wins * 100 / totalWins) : 0;
          listHtml +=
            '<li>ç¬¬ ' + rank + ' åï¼š' +
              escapeHtml(pl.name) +
              ' â€”â€” èµ¢äº† ' + pl.wins + ' æ¬¡ï¼ˆ' + pct.toFixed(1) + '%ï¼‰' +
            '</li>';
        }
        if (listHtml === '<ul class="stats-list">') {
          listHtml = "ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•ä¸€å±€ç©å®¶å¾—åˆ†ä¸ºæ­£ã€‚";
        } else {
          listHtml += '</ul>';
        }
        winsDiv.innerHTML = listHtml;
      }

      // ç»˜åˆ¶é¥¼å›¾ + åœ¨æ‰‡åŒºä¸Šæ ‡æ³¨â€œå§“åï¼Œç™¾åˆ†æ¯”ï¼Œæ€»æ¬¡æ•°â€
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (totalWins > 0) {
        var cx = canvas.width / 2;
        var cy = canvas.height / 2;
        var radius = Math.min(cx, cy) - 10;
        var startAngle = 0;

        for (var m = 0; m < players.length; m++) {
          var pl = players[m];
          if (pl.wins <= 0) continue;

          var sliceAngle = (pl.wins / totalWins) * Math.PI * 2;
          var endAngle = startAngle + sliceAngle;

          // æ‰‡å½¢
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.arc(cx, cy, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fillStyle = pieColors[pl.index % pieColors.length];
          ctx.fill();

          // æ–‡å­—ï¼šå§“å, ç™¾åˆ†æ¯”, æ¬¡æ•°
          var pct = totalWins > 0 ? (pl.wins * 100 / totalWins) : 0;
          var label = pl.name + "ï¼Œ" + pct.toFixed(1) + "%ï¼Œ" + pl.wins + "æ¬¡";

          var midAngle = startAngle + sliceAngle / 2;
          var textRadius = radius * 0.6;
          var tx = cx + Math.cos(midAngle) * textRadius;
          var ty = cy + Math.sin(midAngle) * textRadius;

          ctx.fillStyle = "#111827";
          ctx.font = "10px -apple-system, system-ui";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(label, tx, ty);

          startAngle = endAngle;
        }
      }

      var maxHtml = "";
      var minHtml = "";

      if (maxScore === null) {
        maxHtml = "å•æ¬¡æœ€é«˜å¾—åˆ†ï¼šæš‚æ— è®°å½•ã€‚";
        minHtml = "å•æ¬¡æœ€ä½å¾—åˆ†ï¼šæš‚æ— è®°å½•ã€‚";
      } else {
        var maxName = nameInputs[maxPlayerIndex].value.trim() || ("ç©å®¶" + (maxPlayerIndex + 1));
        var minName = nameInputs[minPlayerIndex].value.trim() || ("ç©å®¶" + (minPlayerIndex + 1));
        var maxRoundNo = maxRound + 1;
        var minRoundNo = minRound + 1;

        maxHtml = "å•æ¬¡æœ€é«˜å¾—åˆ†ï¼š<strong>" +
          escapeHtml(maxName) + "</strong> åœ¨ç¬¬ <strong>" + maxRoundNo +
          "</strong> å±€ï¼Œå¾—åˆ† <strong>" + maxScore + "</strong>ã€‚";

        minHtml = "å•æ¬¡æœ€ä½å¾—åˆ†ï¼š<strong>" +
          escapeHtml(minName) + "</strong> åœ¨ç¬¬ <strong>" + minRoundNo +
          "</strong> å±€ï¼Œå¾—åˆ† <strong>" + minScore + "</strong>ã€‚";
      }

      maxMinDiv.innerHTML = maxHtml + "<br>" + minHtml;
    }

    // ===== æ€»åˆ†è¶‹åŠ¿å›¾ï¼šå›¾ä¾‹ =====
    function buildTrendLegend() {
      var legend = document.getElementById("trendLegend");
      if (!legend) return;
      legend.innerHTML = "";

      for (var i = 0; i < playerCount; i++) {
        if (trendVisible[i] === undefined) {
          trendVisible[i] = true;
        }
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var color = pieColors[i % pieColors.length];

        var label = document.createElement("label");
        label.className = "trend-legend-item";

        var cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = trendVisible[i];
        (function(idx) {
          cb.onchange = function() {
            trendVisible[idx] = this.checked;
            updateTrendChart();
          };
        })(i);

        var colorBox = document.createElement("span");
        colorBox.className = "trend-color-box";
        colorBox.style.backgroundColor = color;

        var textSpan = document.createElement("span");
        textSpan.textContent = name;

        label.appendChild(cb);
        label.appendChild(colorBox);
        label.appendChild(textSpan);
        legend.appendChild(label);
      }
    }

    // ===== æ€»åˆ†è¶‹åŠ¿å›¾ï¼šè‡ªé€‚åº”å®½åº¦ =====
    function resizeTrendCanvas() {
      var canvas = document.getElementById("trendCanvas");
      if (!canvas) return;
      var parent = canvas.parentElement;
      if (!parent) return;

      var parentWidth = parent.clientWidth;
      if (parentWidth <= 0) return;

      // è®¾ç½®å†…éƒ¨ç»˜å›¾å°ºå¯¸
      canvas.width = parentWidth;
      canvas.height = 220;

      updateTrendChart();
    }

    // ===== æ€»åˆ†è¶‹åŠ¿å›¾ï¼šç»˜åˆ¶ =====
    function updateTrendChart() {
      var canvas = document.getElementById("trendCanvas");
      if (!canvas) return;
      var ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      var rounds = historyData.length;
      if (rounds === 0) {
        ctx.fillStyle = "#666";
        ctx.font = "12px -apple-system, BlinkMacSystemFont, system-ui";
        ctx.fillText("æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰", 20, 30);
        return;
      }

      var series = [];
      var minY = null;
      var maxY = null;

      for (var i = 0; i < playerCount; i++) {
        var arr = [];
        var sum = 0;
        for (var r = 0; r < rounds; r++) {
          sum += Number(historyData[r][i] || 0);
          arr.push(sum);
          if (minY === null || sum < minY) minY = sum;
          if (maxY === null || sum > maxY) maxY = sum;
        }
        series.push(arr);
      }

      if (minY === null || maxY === null) {
        ctx.fillStyle = "#666";
        ctx.font = "12px -apple-system, BlinkMacSystemFont, system-ui";
        ctx.fillText("æš‚æ— æœ‰æ•ˆæ•°æ®", 20, 30);
        return;
      }

      if (minY === maxY) {
        if (minY === 0) {
          minY = -10;
          maxY = 10;
        } else {
          var pad = Math.abs(minY) * 0.2;
          minY -= pad;
          maxY += pad;
        }
      } else {
        var span = maxY - minY;
        var pad2 = span * 0.1;
        minY -= pad2;
        maxY += pad2;
      }

      var paddingLeft = 40;
      var paddingRight = 10;
      var paddingTop = 20;
      var paddingBottom = 30;

      var w = canvas.width;
      var h = canvas.height;
      var plotW = w - paddingLeft - paddingRight;
      var plotH = h - paddingTop - paddingBottom;

      function xForRound(rIndex) {
        if (rounds === 1) {
          return paddingLeft + plotW / 2;
        }
        return paddingLeft + (plotW * (rIndex / (rounds - 1)));
      }

      function yForValue(v) {
        return paddingTop + (maxY - v) * plotH / (maxY - minY);
      }

      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, paddingTop + plotH);
      ctx.lineTo(paddingLeft + plotW, paddingTop + plotH);
      ctx.stroke();

      ctx.fillStyle = "#555";
      ctx.font = "11px -apple-system, system-ui";

      for (var r = 0; r < rounds; r++) {
        var x = xForRound(r);
        var y = paddingTop + plotH;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x, y + 3);
        ctx.strokeStyle = "#ccc";
        ctx.stroke();

        if ((r + 1) === 1 || (r + 1) === rounds || (rounds <= 10)) {
          ctx.fillText((r + 1), x - 4, y + 14);
        } else if ((r + 1) % Math.ceil(rounds / 5) === 0) {
          ctx.fillText((r + 1), x - 4, y + 14);
        }
      }

      var steps = 5;
      for (var t = 0; t <= steps; t++) {
        var value = minY + (maxY - minY) * (t / steps);
        var y = yForValue(value);
        ctx.beginPath();
        ctx.moveTo(paddingLeft - 3, y);
        ctx.lineTo(paddingLeft, y);
        ctx.strokeStyle = "#ccc";
        ctx.stroke();
        ctx.fillText(value.toFixed(0), 2, y + 3);
      }

      ctx.lineWidth = 2;
      for (var p = 0; p < playerCount; p++) {
        if (trendVisible[p] === false) continue;
        var data = series[p];
        if (!data || data.length === 0) continue;

        ctx.beginPath();
        for (var rIdx = 0; rIdx < rounds; rIdx++) {
          var x = xForRound(rIdx);
          var y = yForValue(data[rIdx]);
          if (rIdx === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.strokeStyle = pieColors[p % pieColors.length];
        ctx.stroke();
      }
    }

    // ===== é‡ç½®æ•´åœº =====
    function resetAll() {
      roundNumber = 0;
      historyData = [];
      historyTimes = [];
      editingIndex = null;
      activeScoreIndex = null;
      allConfirmIndex = null;
      showAllHistory = false;
      closeKeypad();

      initStateArrays();
      buildPlayersUI();
      buildHistoryHeaderFooter();
      updateFooterTotals();
      refreshInputLockState();
      updateTotalsText();
      updateStatistics();
      resizeTrendCanvas();

      document.getElementById("playerCountText").textContent = playerCount;
      document.getElementById("sumText").innerHTML =
        "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
      document.getElementById("totalText").textContent =
        "å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰";
    }

    // ===== å¯¼å‡º CSVï¼ˆå…¨éƒ¨å±€ï¼Œå«æ—¶é—´ï¼‰ =====
    function exportCSV() {
      var rows = [];
      var header = ["å±€", "æ—¶é—´"];
      for (var i = 0; i < playerCount; i++) {
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        header.push(name);
      }
      rows.push(header);

      var totalRow = ["æ€»è®¡", "â€”"];
      for (var j = 0; j < playerCount; j++) {
        totalRow.push(totalScores[j] || 0);
      }
      rows.push(totalRow);

      for (var r = 0; r < historyData.length; r++) {
        var row = [];
        row.push(r + 1);
        row.push(historyTimes[r] || "");
        var scores = historyData[r];
        for (var p = 0; p < playerCount; p++) {
          row.push(scores[p]);
        }
        rows.push(row);
      }

      function esc(v) {
        var s = String(v);
        if (s.indexOf('"') !== -1 || s.indexOf(',') !== -1 || s.indexOf('\n') !== -1) {
          s = '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      }
      var csvContent = rows.map(function(row) {
        return row.map(esc).join(",");
      }).join("\r\n");

      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "scores.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ===== è‡ªå®šä¹‰æ•°å­—é”®ç›˜é€»è¾‘ =====
    function openKeypad(index) {
      if (scoreConfirmed[index] || scoreInputLocked[index]) return;
      activeScoreIndex = index;

      for (var i = 0; i < scoreInputs.length; i++) {
        scoreInputs[i].classList.remove("score-input-active");
      }
      var input = scoreInputs[index];
      input.classList.add("score-input-active");

      var keypad = document.getElementById("customKeypad");
      keypad.style.display = "block";

      var rect = input.getBoundingClientRect();
      var scrollX = window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0;
      var scrollY = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;

      var left = rect.right + 8 + scrollX;
      var top = rect.top + scrollY;

      var kpWidth = keypad.offsetWidth;
      var kpHeight = keypad.offsetHeight;
      var viewportWidth = document.documentElement.clientWidth;
      var viewportHeight = document.documentElement.clientHeight;

      if (left + kpWidth > scrollX + viewportWidth - 8) {
        left = rect.left + scrollX - kpWidth - 8;
        if (left < scrollX + 4) left = scrollX + 4;
      }

      if (top + kpHeight > scrollY + viewportHeight - 8) {
        top = scrollY + viewportHeight - kpHeight - 8;
        if (top < scrollY + 4) top = scrollY + 4;
      }

      keypad.style.left = left + "px";
      keypad.style.top = top + "px";
    }

    function closeKeypad() {
      var keypad = document.getElementById("customKeypad");
      keypad.style.display = "none";
      for (var i = 0; i < scoreInputs.length; i++) {
        scoreInputs[i].classList.remove("score-input-active");
      }
      activeScoreIndex = null;
    }

    function keypadAppend(ch) {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      var inp = scoreInputs[activeScoreIndex];
      var v = inp.value || "";

      if (ch === '-') {
        if (v.startsWith("-")) {
          v = v.slice(1);
        } else {
          v = "-" + v.replace(/-/g, "");
        }
      } else {
        if (v === "" || v === "-") {
          v = "-" + ch;
        } else {
          v = v + ch;
        }
      }

      inp.value = v;
      refreshInputLockState(activeScoreIndex);
    }

    function keypadBackspace() {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      var inp = scoreInputs[activeScoreIndex];
      var v = inp.value || "";
      if (v.length > 0) {
        v = v.slice(0, -1);
      }
      inp.value = v;
      refreshInputLockState(activeScoreIndex);
    }

    function keypadClear() {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      scoreInputs[activeScoreIndex].value = "";
      refreshInputLockState(activeScoreIndex);
    }

    function toggleMinus() {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      var inp = scoreInputs[activeScoreIndex];
      var v = inp.value || "";
      if (v.startsWith("-")) {
        v = v.slice(1);
      } else {
        v = "-" + v.replace(/-/g, "");
      }
      inp.value = v;
      refreshInputLockState(activeScoreIndex);
    }

    document.addEventListener("click", function(e) {
      var keypad = document.getElementById("customKeypad");
      var clickedOnKeypad = keypad.contains(e.target);
      var clickedOnScore = false;
      for (var i = 0; i < scoreInputs.length; i++) {
        if (scoreInputs[i] === e.target) {
          clickedOnScore = true;
          break;
        }
      }
      if (!clickedOnKeypad && !clickedOnScore) {
        closeKeypad();
      }
    });

    // ===== è‡ªé€‚åº”è¶‹åŠ¿å›¾ï¼šçª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜ =====
    window.addEventListener("resize", resizeTrendCanvas);

    // ===== é¡µé¢åˆå§‹åŒ– =====
    initStateArrays();
    buildPlayersUI();
    buildHistoryHeaderFooter();
    updateFooterTotals();
    refreshInputLockState();
    updateTotalsText();
    updateStatistics();
    resizeTrendCanvas();  // åˆå§‹åŒ–æ—¶è‡ªé€‚åº”ä¸€æ¬¡
    document.getElementById("playerCountText").textContent = playerCount;
  </script>
</body>
</html>
