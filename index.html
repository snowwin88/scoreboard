<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GRLYT60L0R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GRLYT60L0R');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¹²çªçœ¼è®¡åˆ†å™¨</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #f5f5f5;
    }

    .container {
      width: 100%;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin-bottom: 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 16px;
      margin-bottom: 16px;
      box-sizing: border-box;
    }

    .player-count-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
      color: #333;
    }
    .player-count-buttons {
      display: flex;
      gap: 6px;
    }
    .btn-small {
      width: 32px;
      padding: 2px 0;
      font-size: 14px;
      background: #e0e0e0;
      color: #333;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .players-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .player-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 0 4px 8px;
      box-sizing: border-box;
      position: relative;
    }

    .name-select {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #aaa;
      box-sizing: border-box;
      background: #fff;
    }

    /* éšè—ï¼šä»…ç”¨äºä¿å­˜â€œå½“å‰ç©å®¶æœ€ç»ˆåå­—â€ï¼Œå…¼å®¹ä½ åŸé€»è¾‘ nameInputs[i].value */
    .name-input { display: none; }

    /* âœ… å¢å¼º #2ï¼šä¸‹æ‹‰æ¡†ä¸‹é¢çš„å°æç¤º */
    .name-hint {
      width: 100%;
      margin-top: -4px;
      font-size: 12px;
      color: #2563eb;
      line-height: 1.2;
      display: none;
      user-select: none;
    }

    .score-row {
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }

    .score-input {
      width: 100%;
      padding: 6px 4px;
      font-size: 18px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      background: #fff;
    }

    .score-input-active {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
    }

    .score-input-locked {
      background: #eeeeee;
      color: #999999;
      border-color: #cccccc;
    }

    /* âœ… å¢å¼º #3ï¼šè‡ªåŠ¨è¡¥åˆ†æ·¡å…¥åŠ¨ç”» */
    .score-autofill {
      animation: fadeIn 0.35s ease-out;
    }
    @keyframes fadeIn {
      0% { opacity: 0.15; transform: translateY(2px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    button {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: #007aff;
      color: white;
      cursor: pointer;
      box-sizing: border-box;
      transition: opacity 0.12s ease;
    }

    button:disabled {
      background: #bbb;
      color: #666;
      cursor: default;
      opacity: 1;
    }

    /* âœ… å¢å¼º #4ï¼šç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰åœ¨â€œè¿˜ç¼ºæœ€åä¸€ä¸ªåå­—â€æ—¶åŠé€æ˜ï¼Œä½†ä»å¯ç‚¹ */
    .btn-soft {
      opacity: 0.55;
    }

    .table-action-btn {
      width: auto;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
      margin: 0 2px;
    }

    .confirmed {
      background: #f0f0f0;
      font-weight: bold;
      border-color: #bbb;
    }

    .sum {
      font-size: 15px;
      font-weight: 600;
      text-align: center;
      margin-top: 8px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn-save { background: #34c759; flex: 1 1 180px; }
    .btn-reset { background: #e0e0e0; color: #333; flex: 1 1 120px; }

    .totals { margin-top: 10px; }
    .history { margin-top: 10px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    th, td {
      border: 1px solid #eee;
      padding: 4px;
      text-align: center;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }

    /* æ€»è®¡è¡ŒåŸºç¡€æ ·å¼ï¼ˆä¸ä¼šè¦†ç›–æˆ‘ä»¬åé¢æ›´å…·ä½“çš„çº¢/ç»¿/ç°è§„åˆ™ï¼‰ */
    #summaryRow td {
      background: #fff5cc;
      font-weight: 700;
      color: #333;
      height: 26px;
    }

    .btn-export { margin-top: 8px; background: #4b7bec; }

    .hint {
      margin-top: 4px;
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    /* ===== å†å²è¡¨æ ¼ï¼šæ­£è´Ÿåˆ†é¢œè‰² ===== */
    .history-score-pos {
      background: #e8f7ee;
      color: #16a34a;
      font-weight: 700;
    }
    .history-score-neg {
      background: #fdecec;
      color: #dc2626;
      font-weight: 700;
    }
    .history-score-zero {
      background: #f3f4f6;
      color: #374151;
      font-weight: 600;
    }

    /* âœ… æ€»è®¡è¡Œï¼šå¼ºåˆ¶æŒ‰æ­£/è´Ÿ/0 ç€è‰²ï¼Œé¿å…è¢« #summaryRow è¦†ç›– */
    #summaryRow td.history-score-pos { background: #e8f7ee !important; color: #16a34a !important; }
    #summaryRow td.history-score-neg { background: #fdecec !important; color: #dc2626 !important; }
    #summaryRow td.history-score-zero { background: #f3f4f6 !important; color: #374151 !important; }

    /* ===== æ€»åˆ†æ±‡æ€»ï¼šæ¨ªå‘æ’å + å¤§å·åˆ†æ•° ===== */
    .totals-title { font-size: 14px; margin-bottom: 4px; color: #111827; }
    .totals-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; }
    .total-item {
      display: flex; align-items: baseline; gap: 6px;
      padding: 4px 8px; border-radius: 10px; background: #f3f4f6;
    }
    .rank-badge {
      display: inline-block; min-width: 32px; text-align: center;
      padding: 2px 8px; border-radius: 999px;
      background: #facc15; color: #111827; font-weight: 700; font-size: 14px;
    }
    .leader-rank { background: #f97316; color: #ffffff; }
    .player-name { font-size: 14px; min-width: 60px; }
    .player-score { font-size: 32px; font-weight: 800; color: #111827; }
    .player-score-positive { color: #16a34a; }
    .player-score-negative { color: #dc2626; }
    .player-score-zero { color: #4b5563; }
    .leader-score { text-shadow: 0 0 3px rgba(198, 40, 40, 0.4); }

    /* ===== è¶£å‘³ç»Ÿè®¡åŒºåŸŸ ===== */
    .stats-subtitle { font-size: 13px; font-weight: 600; margin: 6px 0; color: #111827; }
    .stats-flex { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-start; }
    .stats-wins-list { font-size: 13px; line-height: 1.5; min-width: 140px; flex: 1; }
    .stats-list { margin: 4px 0; padding-left: 18px; }
    .stats-list li { margin: 2px 0; }
    .stats-maxmin { font-size: 13px; line-height: 1.5; }

    /* ===== è‡ªå®šä¹‰æ•°å­—é”®ç›˜ ===== */
    .keypad-overlay {
      position: absolute;
      background: #1f2933;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 8px 10px 10px;
      box-sizing: border-box;
      z-index: 999;
      border-radius: 10px;
      display: none;
      min-width: 170px;
    }
    .keypad-title {
      font-size: 11px;
      color: #e5e7eb;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .keypad-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }
    .keypad-btn {
      padding: 8px 0;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
    }
    .keypad-btn:active { background: #374151; }
    .keypad-row-bottom {
      display: grid;
      grid-template-columns: 1.5fr 1.5fr 2fr;
      gap: 6px;
      margin-top: 4px;
    }
    .keypad-btn-func {
      padding: 6px 0;
      font-size: 13px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #4b5563;
      color: #f9fafb;
    }
    .keypad-btn-func:active { background: #6b7280; }
    .keypad-btn-ok { background: #10b981; color: #fff; font-weight: 600; }
    .keypad-btn-ok:active { background: #059669; }

    /* ===== è¶‹åŠ¿å›¾ ===== */
    .trend-title { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
    .trend-container { margin-top: 6px; }
    .trend-legend {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
    }
    .trend-legend-item { display: flex; align-items: center; gap: 4px; }
    .trend-color-box { width: 10px; height: 10px; border-radius: 2px; }

    /* ===== ç¼ºå°‘ç©å®¶åæ—¶çš„é«˜äº®æç¤ºï¼ˆè“è‰²+æŠ–åŠ¨ï¼‰ ===== */
    .name-select.attention {
      border-color: #007aff;
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.35);
      animation: shake 0.35s;
    }
    @keyframes shake {
      0%   { transform: translateX(0); }
      25%  { transform: translateX(-4px); }
      50%  { transform: translateX(4px); }
      75%  { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    /* ===== åå­—æœªé½ï¼šåˆ†æ•°è¾“å…¥ç¦ç”¨æ ·å¼ + é¡¶éƒ¨æç¤ºæ¡ ===== */
    .score-input-disabled {
      background: #f3f4f6;
      color: #9ca3af;
      border-color: #e5e7eb;
      cursor: not-allowed;
    }

    .name-gate-banner {
      margin: 8px 0 4px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(0,122,255,0.10);
      border: 1px solid rgba(0,122,255,0.25);
      color: #1d4ed8;
      font-size: 13px;
      line-height: 1.35;
      font-weight: 600;
    }

    .name-gate-banner.pulse {
      animation: gatePulse 0.35s ease-out;
    }
    @keyframes gatePulse {
      0% { transform: scale(0.98); opacity: 0.65; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* ===== å½©è›‹åŠŸèƒ½æ ·å¼ ===== */
    .easter-egg {
      display: inline-block;
      margin-left: 8px;
      font-size: 20px;
      cursor: pointer;
      animation: blink 0.8s ease-in-out infinite;
      transition: transform 0.2s;
    }
    .easter-egg:hover {
      transform: scale(1.3) rotate(15deg);
      animation: blink 0.4s ease-in-out infinite;
    }
    @keyframes blink {
      0%, 49%, 100% { opacity: 1; }
      50%, 99% { opacity: 0.3; }
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .egg-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeInModal 0.3s ease-out;
    }
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .egg-modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 30px 20px;
      max-width: 90%;
      width: 360px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      position: relative;
      animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .egg-modal-close {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 28px;
      color: white;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .egg-modal-close:hover { opacity: 1; }

    .dancing-character {
      text-align: center;
      font-size: 80px;
      margin: 20px 0;
      animation: dance 1s ease-in-out infinite;
    }
    @keyframes dance {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-15px) rotate(-10deg); }
      50% { transform: translateY(0) rotate(0deg); }
      75% { transform: translateY(-15px) rotate(10deg); }
    }

    .egg-message {
      color: white;
      font-size: 16px;
      line-height: 1.6;
      text-align: center;
      margin-top: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-weight: 500;
    }

    .egg-player-name {
      color: #ffd700;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #f0f;
      animation: confettiFall 3s linear infinite;
    }
    @keyframes confettiFall {
      to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }

  </style>
</head>

<body>
  <div class="container">
    <h1>å¹²çªçœ¼è®¡åˆ†å™¨</h1>

    <div class="card">
      <div class="player-count-row">
        <div>å½“å‰ç©å®¶äººæ•°ï¼š<span id="playerCountText">4</span></div>
        
      <div id="nameGateBanner" class="name-gate-banner" style="display:none;">è¯·å…ˆé€‰æ‹©æ‰€æœ‰ç©å®¶åå­—åå†è¾“å…¥åˆ†æ•°</div>
<div class="player-count-buttons">
          <button type="button" class="btn-small" onclick="changePlayerCount(-1)">ï¼</button>
          <button type="button" class="btn-small" onclick="changePlayerCount(1)">ï¼‹</button>
        </div>
      </div>

      <div id="playersRow" class="players-row"></div>
<div id="sumText" class="sum">å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0</div>

      <div class="btn-row">
        <button class="btn-save" onclick="saveRound()">ä¿å­˜æœ¬å±€å¹¶å¼€å§‹ä¸‹ä¸€å±€</button>
        <button class="btn-reset" onclick="resetCurrentRound()">é‡ç½®æœ¬å±€</button>
        <button class="btn-reset" onclick="resetAll()">é‡ç½®æ•´åœº</button>
        <button id="speechToggleBtn" class="btn-reset" style="background:#4caf50;" onclick="toggleSpeech()" title="å¼€å§‹æ’­æŠ¥">â–¶ å¼€å§‹æ’­æŠ¥</button>
      </div>
      <div style="margin-top:10px;text-align:center;">
        <label style="font-size:14px;cursor:pointer;user-select:none;">
          <input type="checkbox" id="autoPlayCheckbox" onchange="toggleAutoPlay()" style="cursor:pointer;margin-right:5px;">
          <span>è‡ªåŠ¨æ’­æ”¾</span>
        </label>
        <span style="font-size:12px;color:#666;margin-left:8px;">(ä¿å­˜æœ¬å±€å’Œç‚¹å‡»å½©è›‹æ—¶è‡ªåŠ¨è¯­éŸ³æ’­æŠ¥)</span>
      </div>
      <div id="speakStatus" style="font-size:12px;color:#666;margin-top:6px;text-align:center;"></div>

      <div id="totalText" class="totals">å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰</div>
    </div>

    <div class="card">
      <div class="history">
        <strong>å†å²æ¯å±€åˆ†æ•°ï¼ˆæ€»è®¡åœ¨æœ€ä¸Šæ–¹ï¼Œæœ€æ–°ä¸€å±€åœ¨æ€»è®¡ä¸‹é¢ï¼‰</strong>
        <table>
          <thead>
            <tr id="historyHeaderRow"></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>

        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-export" id="historyToggleBtn"
                  onclick="toggleHistoryView()"
                  style="flex:0 0 auto; display:none;">
            æŸ¥çœ‹å…¨éƒ¨
          </button>
          <button class="btn-export" onclick="exportCSV()" style="flex:0 0 auto;">
            å¯¼å‡º CSVï¼ˆå…¨éƒ¨å±€ï¼‰
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="trend-title">æ€»åˆ†è¶‹åŠ¿å›¾ï¼ˆX è½´ï¼šå±€æ•°ï¼ŒY è½´ï¼šç´¯ç§¯æ€»åˆ†ï¼‰</div>
      <div class="trend-container">
        <canvas id="trendCanvas" style="width:100%; height:220px; display:block;"></canvas>
        <div id="trendLegend" class="trend-legend"></div>
      </div>
    </div>

    <div class="card">
      <strong>è¶£å‘³ç»Ÿè®¡</strong>

      <div class="stats-section" style="margin-top:6px;">
        <div class="stats-subtitle">1. èµ¢çš„æ¬¡æ•°ç»Ÿè®¡ï¼ˆå¾—åˆ†ä¸ºæ­£çš„å±€æ•°ï¼‰</div>
        <div class="stats-flex">
          <canvas id="statsPie" width="220" height="220" style="max-width:220px;"></canvas>
          <div id="statsWinsList" class="stats-wins-list">æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚</div>
        </div>
      </div>

      <div class="stats-section" style="margin-top:10px;">
        <div class="stats-subtitle">2. å•å±€å¾—åˆ†çºªå½•</div>
        <div id="statsMaxMin" class="stats-maxmin">æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚</div>
      </div>
    </div>

    <div class="card">
      <div class="hint">
        âœ¦ é»˜è®¤ 4 äººï¼Œå¯ä»¥é€šè¿‡ä¸Šæ–¹ã€Œï¼ / ï¼‹ã€è°ƒæ•´ 2ï½8 äººã€‚<br>
        âœ¦ é»˜è®¤ä¸é€‰ä¸­ä»»ä½•ç©å®¶ï¼Œæ˜¾ç¤ºã€Œé€‰æ‹©ç©å®¶â€¦ã€ã€‚é€‰æ‹©ã€Œè‡ªå®šä¹‰â€¦ã€å¯è¾“å…¥åå­—å¹¶ä¼šæ˜¾ç¤ºåœ¨ä¸‹æ‹‰æ¡†ä¸­ã€‚<br>
        âœ¦ ç‚¹å‡»ç©å®¶åˆ†æ•°æ¡†è°ƒå‡ºè‡ªå®šä¹‰æ•°å­—é”®ç›˜ï¼Œé»˜è®¤è¾“å…¥ä¸ºè´Ÿæ•°ï¼Œå¦‚éœ€æ­£æ•°å¯ç‚¹å‡»ã€ŒÂ±ã€ã€‚<br>
        âœ¦ å½“æœ‰ Nâˆ’1 ä¸ªç©å®¶å·²ç»è¾“å…¥åˆ†æ•°åï¼Œæœ€åä¸€ä¸ªç©å®¶ä¼šè‡ªåŠ¨é”å®šï¼Œä¸èƒ½æ‰‹å·¥è¾“å…¥ï¼›<br>
        âœ¦ æ­¤æ—¶ç¬¬ Nâˆ’1 ä¸ªå®Œæˆè¾“å…¥çš„ç©å®¶æŒ‰é’®ä¼šå˜æˆã€Œç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰ã€ï¼Œå¯ä¸€é”®æäº¤æœ¬å±€ï¼›<br>
        âœ¦ ä»»æ„ Nâˆ’1 äººç¡®è®¤åï¼Œç¬¬ N äººè‡ªåŠ¨ç®—å‡ºï¼Œä¿è¯æœ¬å±€æ€»å’Œ = 0ã€‚<br>
        âœ¦ ã€Œä¿å­˜æœ¬å±€ã€åªæ¸…ç©ºåˆ†æ•°ï¼Œä¸ä¼šæ¸…ç©ºç©å®¶å§“åï¼›ã€Œé‡ç½®æ•´åœºã€ä¼šæ¸…ç©ºæ‰€æœ‰å†å²ä¸æ€»åˆ†ã€‚<br>
      </div>
    </div>
  </div>

  <!-- å½©è›‹æ¨¡æ€æ¡† -->
  <div id="eggModal" class="egg-modal" onclick="closeEggModal(event)">
    <div class="egg-modal-content" onclick="event.stopPropagation()">
      <button class="egg-modal-close" onclick="closeEggModal()">&times;</button>
      <div id="eggPlayerName" class="egg-player-name"></div>
      <div class="dancing-character" id="dancingChar">ğŸ‰</div>
      <div id="eggMessage" class="egg-message"></div>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰æ•°å­—é”®ç›˜ -->
  <div id="customKeypad" class="keypad-overlay">
    <div class="keypad-title">
      <span>æ•°å­—é”®ç›˜</span>
      <button class="keypad-btn-func" style="width:auto;padding:2px 8px;font-size:11px;"
              onclick="closeKeypad()">æ”¶èµ·</button>
    </div>
    <div class="keypad-grid">
      <button class="keypad-btn" onclick="keypadAppend('7')">7</button>
      <button class="keypad-btn" onclick="keypadAppend('8')">8</button>
      <button class="keypad-btn" onclick="keypadAppend('9')">9</button>

      <button class="keypad-btn" onclick="keypadAppend('4')">4</button>
      <button class="keypad-btn" onclick="keypadAppend('5')">5</button>
      <button class="keypad-btn" onclick="keypadAppend('6')">6</button>

      <button class="keypad-btn" onclick="keypadAppend('1')">1</button>
      <button class="keypad-btn" onclick="keypadAppend('2')">2</button>
      <button class="keypad-btn" onclick="keypadAppend('3')">3</button>
    </div>
    <div class="keypad-grid" style="grid-template-columns: 1fr 1fr 1fr;">
      <button class="keypad-btn" onclick="toggleMinus()">Â±</button>
      <button class="keypad-btn" onclick="keypadAppend('0')">0</button>
      <button class="keypad-btn" onclick="keypadAppend('-')">-</button>
    </div>
    <div class="keypad-row-bottom">
      <button class="keypad-btn-func" onclick="keypadBackspace()">é€€æ ¼</button>
      <button class="keypad-btn-func" onclick="keypadClear()">æ¸…ç©º</button>
      <button class="keypad-btn-func keypad-btn-ok" onclick="closeKeypad()">å®Œæˆ</button>
    </div>
  </div>

  <script>
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (s) {
        switch (s) {
          case "&": return "&amp;";
          case "<": return "&lt;";
          case ">": return "&gt;";
          case '"': return "&quot;";
          case "'": return "&#39;";
          default: return s;
        }
      });
    }

    function getCurrentTimestamp() {
      var d = new Date();
      function pad(n) { return n < 10 ? "0" + n : "" + n; }
      return d.getFullYear() + "-" +
             pad(d.getMonth() + 1) + "-" +
             pad(d.getDate()) + " " +
             pad(d.getHours()) + ":" +
             pad(d.getMinutes()) + ":" +
             pad(d.getSeconds());
    }

    var defaultNames = [
      "JINHUA","ZHOUKUN","MAJIAN","GUANGMING","MINNA","YA","BETTY","VINCENT","CAIFANG"
    ];

    var playerCount = 4;
    var nameInputs = [];
    var nameSelects = [];
    var nameHints = [];
    var scoreInputs = [];
    var confirmButtons = [];

    var scoreConfirmed = [];
    var scoreValues = [];
    var totalScores = [];
    var roundNumber = 0;

    var historyData = [];
    var historyTimes = [];
    var editingIndex = null;

    var activeScoreIndex = null;
    var scoreInputLocked = [];
    var allConfirmIndex = null;

    var pieColors = [
      "#f97316", "#3b82f6", "#10b981", "#e11d48",
      "#8b5cf6", "#0ea5e9", "#22c55e", "#facc15"
    ];

    // å­˜å‚¨æœ€åä¸€æ¬¡çš„æ’­æŠ¥æ–‡æœ¬
    var lastRoundText = "";
    var lastTotalText = "";
    var isSpeaking = false; // æ’­æŠ¥çŠ¶æ€
    var autoPlayEnabled = false; // è‡ªåŠ¨æ’­æ”¾å¼€å…³ï¼Œé»˜è®¤å…³é—­
    var selectedVoice = null; // é€‰ä¸­çš„è¯­éŸ³å¼•æ“
    var availableVoices = []; // å¯ç”¨çš„è¯­éŸ³åˆ—è¡¨

    // åˆå§‹åŒ–è¯­éŸ³å¼•æ“
    function initVoices() {
      availableVoices = speechSynthesis.getVoices();
      
      // ä¼˜å…ˆçº§åˆ—è¡¨ï¼šé€‰æ‹©æœ€è‡ªç„¶çš„ä¸­æ–‡è¯­éŸ³
      var voicePriority = [
        'Tingting',           // ä¸­æ–‡ï¼ˆä¸­å›½å¤§é™†ï¼‰- è´¨é‡è¾ƒå¥½
        'Yaoyao',             // ä¸­æ–‡ï¼ˆä¸­å›½å¤§é™†ï¼‰
        'Xiaoyi',             // ä¸­æ–‡ï¼ˆä¸­å›½å¤§é™†ï¼‰
        'Microsoft Yunxi',    // Edgeæµè§ˆå™¨çš„é«˜è´¨é‡ä¸­æ–‡è¯­éŸ³
        'Microsoft Xiaoxiao', // Edgeæµè§ˆå™¨
        'Microsoft Kangkang', // Edgeæµè§ˆå™¨ï¼ˆç”·å£°ï¼‰
        'Google æ™®é€šè¯',      // Googleä¸­æ–‡
        'zh-CN',              // é€šç”¨ä¸­æ–‡æ ‡è¯†
        'zh-TW',              // ä¸­æ–‡ï¼ˆå°æ¹¾ï¼‰
        'Chinese'             // é€šç”¨ä¸­æ–‡
      ];
      
      // å°è¯•æŒ‰ä¼˜å…ˆçº§æŸ¥æ‰¾æœ€ä½³è¯­éŸ³
      for (var i = 0; i < voicePriority.length; i++) {
        var priorityName = voicePriority[i];
        for (var j = 0; j < availableVoices.length; j++) {
          var voice = availableVoices[j];
          if (voice.name.indexOf(priorityName) !== -1 || voice.lang.indexOf('zh') !== -1) {
            selectedVoice = voice;
            console.log('å·²é€‰æ‹©è¯­éŸ³å¼•æ“ï¼š' + voice.name + ' (' + voice.lang + ')');
            return;
          }
        }
      }
      
      // å¦‚æœæ²¡æ‰¾åˆ°ä¸­æ–‡è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤çš„ç¬¬ä¸€ä¸ª
      if (availableVoices.length > 0) {
        selectedVoice = availableVoices[0];
        console.log('ä½¿ç”¨é»˜è®¤è¯­éŸ³ï¼š' + selectedVoice.name);
      }
    }

    // ä¼˜åŒ–æ’­æŠ¥æ–‡æœ¬ï¼Œæ·»åŠ è‡ªç„¶åœé¡¿
    function optimizeTextForSpeech(text) {
      // åœ¨é€—å·ã€é¡¿å·åæ·»åŠ çŸ­åœé¡¿
      text = text.replace(/ï¼Œ/g, 'ï¼Œã€');
      text = text.replace(/ï¼š/g, 'ï¼šã€ã€');
      // åœ¨æ•°å­—å‰åæ·»åŠ å¾®åœé¡¿ï¼Œä½¿æ•°å­—è¯»å¾—æ›´æ¸…æ¥š
      text = text.replace(/(\d+)/g, ' $1 ');
      return text;
    }

    // æ›´æ–°æ’­æŠ¥æŒ‰é’®çŠ¶æ€
    function updateSpeechButton(speaking) {
      var btn = document.getElementById('speechToggleBtn');
      if (!btn) return;
      
      isSpeaking = speaking;
      if (speaking) {
        btn.innerHTML = 'â¹ åœæ­¢æ’­æŠ¥';
        btn.style.background = '#e74c3c';
        btn.title = 'åœæ­¢è¯­éŸ³æ’­æŠ¥';
      } else {
        btn.innerHTML = 'â–¶ å¼€å§‹æ’­æŠ¥';
        btn.style.background = '#4caf50';
        btn.title = 'å¼€å§‹æ’­æŠ¥';
      }
    }

    // åˆ‡æ¢æ’­æŠ¥çŠ¶æ€
    function toggleSpeech() {
      if (isSpeaking) {
        // å½“å‰æ­£åœ¨æ’­æŠ¥ï¼Œåœæ­¢å®ƒ
        speechSynthesis.cancel();
        updateSpeechButton(false);
      } else {
        // å½“å‰æ²¡æœ‰æ’­æŠ¥ï¼Œå¼€å§‹æ’­æŠ¥
        if (!lastRoundText || !lastTotalText) {
          alert("æš‚æ— æ’­æŠ¥è®°å½•ï¼Œè¯·å…ˆå®Œæˆä¸€å±€æ¸¸æˆã€‚");
          return;
        }
        replayLastSpeech();
      }
    }

    // åˆ‡æ¢è‡ªåŠ¨æ’­æ”¾å¼€å…³
    function toggleAutoPlay() {
      autoPlayEnabled = !autoPlayEnabled;
      var checkbox = document.getElementById('autoPlayCheckbox');
      if (checkbox) {
        checkbox.checked = autoPlayEnabled;
      }
      // ä¿å­˜è®¾ç½®åˆ°localStorage
      try {
        localStorage.setItem('scoreboard_autoplay', autoPlayEnabled ? '1' : '0');
      } catch(e) {}
    }

    // å½©è›‹åŠŸèƒ½ï¼šèƒœåˆ©è€…æ–‡å­—åº“ï¼ˆ30å­—ä»¥å†…ï¼‰
    var winnerMessages = [
      "æ­å–œä½ ï¼ç¨³åæ¦œé¦–ï¼è¿™æ³¢æ“ä½œå¤ª6äº†ï¼Œç»§ç»­ä¿æŒé¢†å…ˆä¼˜åŠ¿ï¼",
      "çœŸæ˜¯å¤ªå‰å®³äº†ï¼ä½ å°±æ˜¯ä»Šå¤©çš„ç‹è€…ï¼Œæ‰€æœ‰äººéƒ½è¦ä»°æœ›ä½ ï¼",
      "ç¬¬ä¸€åçš„æ„Ÿè§‰æ˜¯ä¸æ˜¯å¾ˆçˆ½ï¼Ÿäº«å—è¿™ä»½è£è€€å§ï¼Œä½ å€¼å¾—æ‹¥æœ‰ï¼",
      "æ— äººèƒ½æŒ¡ï¼ä½ çš„å®åŠ›æœ‰ç›®å…±ç¹ï¼Œç»§ç»­ç§°éœ¸èµ›åœºï¼",
      "ç«™åœ¨å·…å³°çš„æ„Ÿè§‰å¦‚ä½•ï¼Ÿä¿æŒçŠ¶æ€ï¼Œè®©ä»–ä»¬æœ›å°˜è«åŠï¼",
      "ä½ å°±æ˜¯ä¼ è¯´ä¸­çš„é«˜æ‰‹ï¼è¿™å±€èµ¢å¾—æ¼‚äº®ï¼Œæ°”åŠ¿å¦‚è™¹ï¼",
      "é¥é¥é¢†å…ˆï¼ä½ çš„æŠ€æœ¯è®©å¯¹æ‰‹ä»¬ç‘Ÿç‘Ÿå‘æŠ–ï¼",
      "ç‹è€…é™ä¸´ï¼ä½ ç”¨å®åŠ›è¯æ˜äº†ä»€ä¹ˆå«çœŸæ­£çš„å¼ºè€…ï¼",
      "å¤ªç²¾å½©äº†ï¼ä½ çš„æ¯ä¸€æ­¥éƒ½å ªç§°æ•™ç§‘ä¹¦çº§åˆ«çš„æ“ä½œï¼",
      "ç¨³å¦‚æ³°å±±ï¼ä½ çš„é¢†å…ˆä¼˜åŠ¿è®©äººé«˜å±±ä»°æ­¢ï¼",
      "éœ¸æ°”ä¾§æ¼ï¼ç¬¬ä¸€åçš„å®åº§ä¸ºä½ è€Œè®¾ï¼Œå®è‡³åå½’ï¼",
      "æ— æ•Œæ˜¯å¤šä¹ˆå¯‚å¯ï¼å† å†›çš„å…‰ç¯åœ¨ä½ å¤´ä¸Šé—ªè€€ï¼",
      "ç¥çº§å‘æŒ¥ï¼è¿™åœºèƒœåˆ©å†™ä¸‹äº†ä½ çš„ä¼ å¥‡ç¯‡ç« ï¼",
      "åŠ¿ä¸å¯æŒ¡ï¼ä½ çš„ä¼˜åŠ¿å·²ç»è®©å¯¹æ‰‹ä»¬ç»æœ›äº†ï¼",
      "å®Œç¾ï¼ä½ ç”¨å®åŠ›è¯ é‡Šäº†ä»€ä¹ˆå«åšçœŸæ­£çš„å† å†›ï¼",
      "å¼ºåŠ¿é¢†è·‘ï¼ä½ çš„èƒŒå½±æ˜¯æœ€ç¾çš„é£æ™¯çº¿ï¼",
      "ç™»å³°é€ æï¼è¿™ä¸ªç¬¬ä¸€åå«é‡‘é‡åè¶³ï¼",
      "æ‰€å‘æŠ«é¡ï¼ç»§ç»­è¿™æ ·ï¼Œå† å†›éä½ è«å±ï¼",
      "å¤©ç§€æ“ä½œï¼ä½ å·²ç»æŠŠç¬¬ä¸€ååç¨³äº†ï¼",
      "æ— æ‡ˆå¯å‡»ï¼ä½ çš„è¡¨ç°è®©æ‰€æœ‰äººå¹ä¸ºè§‚æ­¢ï¼",
      "éœ¸æ¦œäº†ï¼ç¬¬ä¸€åçš„ä½ç½®å°±æ˜¯ä½ çš„ä¸“å±åº§ä½ï¼",
      "å®åŠ›ç¢¾å‹ï¼å¯¹æ‰‹åœ¨ä½ é¢å‰éƒ½æ˜¯æµ®äº‘ï¼",
      "é«˜æ‰‹é£èŒƒï¼ä½ çš„æ¯ä¸€æ­¥éƒ½é€éœ²ç€ç‹è€…æ°”æ¯ï¼",
      "ç‹‚é£™çªè¿›ï¼ä½ çš„é¢†å…ˆä¼˜åŠ¿è¶Šæ¥è¶Šå¤§äº†ï¼",
      "ç‹¬é¢†é£éªšï¼ç¬¬ä¸€åçš„è£è€€å±äºä½ ï¼",
      "åŠ¿å¦‚ç ´ç«¹ï¼æ²¡äººèƒ½é˜»æŒ¡ä½ å‰è¿›çš„æ­¥ä¼ï¼",
      "å›ä¸´å¤©ä¸‹ï¼ä½ å°±æ˜¯è¿™ä¸ªæ¸¸æˆçš„ä¸»å®°è€…ï¼",
      "å…‰èŠ’ä¸‡ä¸ˆï¼ä½ çš„å®åŠ›ç…§äº®äº†æ•´ä¸ªèµ›åœºï¼",
      "ä¸€éª‘ç»å°˜ï¼å…¶ä»–äººåªèƒ½æœ›ä½ é¡¹èƒŒï¼",
      "å·…å³°çŠ¶æ€ï¼ä½ ç°åœ¨çš„è¡¨ç°å ªç§°å®Œç¾ï¼",
      "ç‹è€…å½’æ¥ï¼è¿™ä¸ªç¬¬ä¸€åå®è‡³åå½’ï¼",
      "å¼ºè€…æ’å¼ºï¼ç»§ç»­ä¿æŒï¼Œèƒœåˆ©å±äºä½ ï¼",
      "éœ‡æ’¼å…¨åœºï¼ä½ çš„è¡¨ç°è®©æ‰€æœ‰äººæƒŠå¹ï¼",
      "å‚²è§†ç¾¤é›„ï¼ä½ å°±æ˜¯ä»Šå¤©æœ€äº®çš„æ˜Ÿï¼",
      "æ°”åŠ¿å¦‚è™¹ï¼å† å†›çš„æ°”è´¨å±•éœ²æ— é—ï¼",
      "ç¥ç¨å¤©ä¸‹ï¼ç¬¬ä¸€åçš„å¨é£æ— äººèƒ½åŠï¼",
      "æ¨ªæ‰«åƒå†›ï¼ä½ çš„å®åŠ›è®©å¯¹æ‰‹æ— åœ°è‡ªå®¹ï¼",
      "ç‹¬æ­¥å¤©ä¸‹ï¼è¿™ä¸ªç¬¬ä¸€åä½ å½“ä¹‹æ— æ„§ï¼",
      "ç›–ä¸–æ— åŒï¼ä½ çš„è¡¨ç°å·²ç»å°ç¥äº†ï¼",
      "ä¸€é¸£æƒŠäººï¼ç¬¬ä¸€åçš„æ¡‚å† ä¸ºä½ æˆ´ä¸Šï¼",
      "æŠ€å‹ç¾¤èŠ³ï¼ä½ çš„æ°´å¹³å·²ç»è¶…å‡¡è„±ä¿—ï¼",
      "è±ªæ°”å†²å¤©ï¼å† å†›å°±è¯¥æœ‰ä½ è¿™æ ·çš„æ°”åŠ¿ï¼",
      "åŠ›å‹ç¾¤é›„ï¼ç¬¬ä¸€åçš„å®åº§ç¨³å¦‚ç£çŸ³ï¼",
      "é£åç»ä»£ï¼ä½ çš„è¡¨ç°å°†è½½å…¥å²å†Œï¼",
      "å“å°”ä¸ç¾¤ï¼ä½ çš„å®åŠ›é«˜å‡ºä¸€ä¸ªæ¡£æ¬¡ï¼",
      "å±å’¤é£äº‘ï¼ç¬¬ä¸€åçš„å…‰ç¯ç…§è€€å…¨åœºï¼",
      "çºµæ¨ªæ— æ•Œï¼ä½ å·²ç»ç«™åœ¨äº†å·…å³°ä¹‹å·…ï¼",
      "é›„éœ¸å¤©ä¸‹ï¼å† å†›ä¹‹è·¯ä¸ºä½ é“ºå°±ï¼",
      "å¨éœ‡å››æ–¹ï¼ä½ çš„åå­—å°†é“­åˆ»åœ¨ç¬¬ä¸€åæ¦œä¸Šï¼",
      "æ°”åå±±æ²³ï¼è¿™æ ·çš„éœ¸æ°”åªæœ‰å† å†›æ‰æœ‰ï¼"
    ];

    // å½©è›‹åŠŸèƒ½ï¼šè½åè€…æ–‡å­—åº“ï¼ˆ30å­—ä»¥å†…ï¼‰
    var loserMessages = [
      "æš‚æ—¶è½åä¸è¦ç´§ï¼å§è–ªå°èƒ†ï¼Œä¸‹ä¸€å±€å¿…å®šç‹è€…å½’æ¥ï¼",
      "è¶ŠæŒ«è¶Šå‹‡ï¼ç›¸ä¿¡è‡ªå·±ï¼Œç»åœ°åå‡»çš„æ—¶åˆ»å³å°†åˆ°æ¥ï¼",
      "åˆ«ç°å¿ƒï¼å¡ç¿å¤±é©¬ç„‰çŸ¥éç¦ï¼Œé€†é£ç¿»ç›˜æ‰æœ€ç²¾å½©ï¼",
      "å¤±è´¥æ˜¯æˆåŠŸä¹‹æ¯ï¼æ€»ç»“ç»éªŒï¼Œä¸‹å±€æ‰“ä»–ä»¬ä¸ªæªæ‰‹ä¸åŠï¼",
      "ä¸æœè¾“çš„ç²¾ç¥æœ€å¯è´µï¼è“„åŠ¿å¾…å‘ï¼Œåè¶…å°±åœ¨çœ¼å‰ï¼",
      "è¿™åªæ˜¯å¼€å§‹ï¼çœŸæ­£çš„é«˜æ‰‹ä»ä¸è½»è¨€æ”¾å¼ƒï¼ŒåŠ æ²¹ï¼",
      "è«æ…Œï¼é£æ°´è½®æµè½¬ï¼Œä¸‹ä¸€ä¸ªèƒœè€…å°±æ˜¯ä½ ï¼",
      "æš‚æ—¶æ®¿åï¼Œä½†å¿—åœ¨å¿…å¾—ï¼åå‡»çš„å·è§’å·²ç»å¹å“ï¼",
      "å›°å¢ƒé€ å°±è‹±é›„ï¼ä½ çš„é€†è¢­æ•…äº‹æ­£åœ¨ä¸Šæ¼”ï¼",
      "è¾“äº†ä¸€å±€ä¸ç®—ä»€ä¹ˆï¼ç¬‘åˆ°æœ€åçš„æ‰æ˜¯çœŸæ­£çš„èµ¢å®¶ï¼",
      "åƒé‡Œä¹‹è¡Œå§‹äºè¶³ä¸‹ï¼ä»ç°åœ¨å¼€å§‹ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯é€†è¢­ï¼",
      "æš‚å±…æœ«ä½ä¸å¯æ€•ï¼å¯æ€•çš„æ˜¯å¤±å»æ–—å¿—ï¼ŒåŠ æ²¹ï¼",
      "ä½è°·æ˜¯æš‚æ—¶çš„ï¼åšæŒä¸‹å»ï¼Œæ›™å…‰å°±åœ¨å‰æ–¹ï¼",
      "ä¸ç»å†é£é›¨æ€è§å½©è™¹ï¼ä½ çš„èƒœåˆ©åœ¨è·¯ä¸Šï¼",
      "è·Œå€’äº†å°±çˆ¬èµ·æ¥ï¼çœŸæ­£çš„å‹‡å£«ä»ä¸è¨€è´¥ï¼",
      "æœ€åä¸€åä¹Ÿæœ‰æ˜¥å¤©ï¼ç»åœ°åå‡»å°±æ˜¯ç°åœ¨ï¼",
      "æš‚æ—¶çš„å¤±åˆ©æ¢æ¥å®è´µç»éªŒï¼ä¸‹å±€å¿…å®šç¿»ç›˜ï¼",
      "åˆ«æ€¥ï¼å¥½æˆæ€»åœ¨åå¤´ï¼Œä½ çš„ç²¾å½©å³å°†ä¸Šæ¼”ï¼",
      "è½åä¸ä»£è¡¨å¤±è´¥ï¼åšæŒå°±æ˜¯èƒœåˆ©çš„å¼€å§‹ï¼",
      "å¡ç¿å¤±é©¬ç„‰çŸ¥éç¦ï¼è¿™åªæ˜¯æˆåŠŸå‰çš„ç£¨ç ºï¼",
      "ç»å¢ƒä¸­è§çœŸç« ï¼ä½ çš„åå‡»æ—¶åˆ»åˆ°äº†ï¼",
      "æš‚æ—¶å«åº•æ²¡å…³ç³»ï¼å†²ä¸Šæ¥æ‰æ›´æœ‰æˆå°±æ„Ÿï¼",
      "ä¸æŠ›å¼ƒä¸æ”¾å¼ƒï¼é€†é£ç¿»ç›˜çš„æ•…äº‹ç”±ä½ ä¹¦å†™ï¼",
      "å›°å¢ƒæ˜¯æˆé•¿çš„å¥‘æœºï¼ä¸‹ä¸€å±€å°±æ˜¯ä½ çš„å¤©ä¸‹ï¼",
      "ç«™åœ¨æœ€åä¸ä¸¢äººï¼å¾€å‰å†²æ‰æ˜¯ç‹é“ï¼",
      "æ¯ä¸€æ¬¡ä½è°·éƒ½æ˜¯åå¼¹çš„èµ·ç‚¹ï¼åŠ æ²¹ï¼",
      "æš‚æ—¶è½åç®—ä»€ä¹ˆï¼ç¿»ç›˜æ‰æ˜¯æœ€ç²¾å½©çš„å‰§æœ¬ï¼",
      "å¤±è´¥åªæ˜¯æš‚æ—¶çš„ï¼æˆåŠŸå°±åœ¨ä¸‹ä¸€ä¸ªè½¬è§’ï¼",
      "æœ€åä¸€åä¹Ÿæ˜¯ä¸€ç§åŠ›é‡ï¼é€†è¢­ä»è¿™é‡Œå¼€å§‹ï¼",
      "åˆ«çœ‹ç°åœ¨è½åï¼ä¸‹å±€è®©ä»–ä»¬åˆ®ç›®ç›¸çœ‹ï¼",
      "ä½è°·æ˜¯ä¸ºäº†æ›´é«˜çš„è·ƒèµ·ï¼å‡†å¤‡å¥½äº†å—ï¼Ÿ",
      "æš‚æ—¶å«åº•ä¸è¦ç´§ï¼åšæŒå°±èƒ½çœ‹åˆ°å¸Œæœ›ï¼",
      "è¾“äº†ä¸€å±€æ²¡å…³ç³»ï¼é‡è¦çš„æ˜¯ä¸‹å±€çš„æ€åº¦ï¼",
      "è½åæ˜¯æš‚æ—¶çš„ï¼ä½ çš„çˆ†å‘åŠ›æ— äººèƒ½åŠï¼",
      "åˆ«ç°å¿ƒï¼æ¯ä¸ªå† å†›éƒ½ç»å†è¿‡ä½è°·ï¼",
      "æœ€åä¸€åä¹Ÿæœ‰å°Šä¸¥ï¼å¥‹èµ·ç›´è¿½æ‰æ˜¯ç¡¬é“ç†ï¼",
      "æš‚æ—¶è½åä¸ç®—è¾“ï¼åšæŒåˆ°åº•æ‰æ˜¯èµ¢å®¶ï¼",
      "ä½è¿·æœŸæ€»ä¼šè¿‡å»ï¼ä½ çš„æ˜¥å¤©é©¬ä¸Šåˆ°æ¥ï¼",
      "åˆ«æ”¾å¼ƒï¼é€†è¢­çš„æ•…äº‹æœ€æ¿€åŠ¨äººå¿ƒï¼",
      "è½åæ¿€å‘æ–—å¿—ï¼ä¸‹ä¸€å±€å°±æ˜¯ä½ çš„èˆå°ï¼",
      "æš‚å±…æœ«å¸­ä¸å¯æ€•ï¼å¯æ€•çš„æ˜¯ä¸æ•¢å‘å‰ï¼",
      "å¤±åˆ©æ˜¯æˆåŠŸçš„é“ºå«ï¼ç›¸ä¿¡è‡ªå·±çš„å®åŠ›ï¼",
      "æœ€åä¸€åä¹Ÿæ˜¯å‚ä¸è€…ï¼ä¸‹å±€å°±æ˜¯é€†è¢­å±€ï¼",
      "æš‚æ—¶è½åæ²¡ä»€ä¹ˆï¼é‡è¦çš„æ˜¯æ°¸ä¸è¨€å¼ƒï¼",
      "ä½è°·ä¸­è•´å«åŠ›é‡ï¼ä½ çš„åå¼¹å³å°†å¼€å§‹ï¼",
      "åˆ«çœ‹ç°åœ¨æœ€åï¼ä¸‹å±€è®©ä»–ä»¬å¤§åƒä¸€æƒŠï¼",
      "è½åæ˜¯ä¸ºäº†æ›´å¥½çš„å†²åˆºï¼åŠ è¶³é©¬åŠ›ï¼",
      "æš‚æ—¶å«åº•ä¸ä¸¢äººï¼å‹‡æ•¢é¢å¯¹æ‰æ˜¯è‹±é›„ï¼",
      "å¤±è´¥æ•™ä¼šä½ ç»éªŒï¼ä¸‹ä¸€å±€å°±ç”¨ä¸Šï¼",
      "æœ€åä¸€åä¹Ÿæœ‰æ¢¦æƒ³ï¼é€†è¢­ä»ä¸è¿Ÿåˆ°ï¼"
    ];

    // å½©è›‹åŠŸèƒ½ï¼šä¸­ç­‰å¾—åˆ†ï¼ˆâ‰¥0ï¼‰æ–‡å­—åº“ï¼ˆæ—¢æœ‰æˆå°±æ„Ÿï¼Œåˆè¦è¿½èµ¶ç¬¬ä¸€ï¼‰
    var midHighMessages = [
      "ä¸é”™å•Šï¼å†æ¥å†å‰ï¼Œæƒ³è±¡ç¬¬ä¸€åå°±åœ¨çœ¼å‰ï¼Œå†²åˆºï¼",
      "å¹²å¾—æ¼‚äº®ï¼ç¦»ç¬¬ä¸€åè¶Šæ¥è¶Šè¿‘äº†ï¼Œç»§ç»­åŠ æ²¹ï¼",
      "ç¨³æ‰ç¨³æ‰“ï¼Œç»§ç»­è¿½èµ¶ï¼Œä¸‹ä¸€å±€è¶…è¶Šç¬¬ä¸€åæŒ‡æ—¥å¯å¾…ï¼",
      "å¾ˆæœ‰è¿›å±•ï¼åšæŒè¿™ä¸ªçŠ¶æ€ï¼Œèƒœåˆ©å°±åœ¨è½¬è§’å¤„ç­‰ä½ ï¼",
      "ä¸ä¿—çš„è¡¨ç°ï¼æƒ³æƒ³é‚£ä¸ªç¬¬ä¸€åå§ï¼Œå’±ä»¬æ¥è¿½ä»–ï¼",
      "èŠ‚èŠ‚é«˜å‡çš„æ„Ÿè§‰çœŸæ£’ï¼å†²å‘ç¬¬ä¸€åï¼Œå°±å·®æœ€åä¸€æ­¥ï¼",
      "ä¿æŒçƒ­åº¦ï¼ç¬¬ä¸€åçœ‹ä½ çš„çœ¼ç¥å¼€å§‹ç´§å¼ äº†å“ˆï¼",
      "ä½ æ­£åœ¨é€¼è¿‘ï¼ç¬¬ä¸€åçš„çš‡åº§åœ¨å‘ä½ æ‹›æ‰‹å‘¢ï¼",
      "æ°”åŠ¿å¾ˆè¶³ï¼ç»§ç»­è¿™æ ·ï¼Œç¬¬ä¸€åçš„å®åº§å¾ˆå¿«å°±æ˜¯ä½ çš„ï¼",
      "æ¸å…¥ä½³å¢ƒï¼å†åŠªåŠ›ä¸€æŠŠï¼Œç¬¬ä¸€å°±åœ¨ä¸‹ä¸€å±€ç­‰ä½ ï¼"
    ];

    // å½©è›‹åŠŸèƒ½ï¼šä¸­ç­‰å¾—åˆ†ï¼ˆ<0ï¼‰æ–‡å­—åº“ï¼ˆå¹½é»˜æç¬‘ï¼Œé¼“åŠ±ç»§ç»­åŠªåŠ›ï¼‰
    var midLowMessages = [
      "å“å‘€ï¼Œè¿˜æœ‰å¾ˆå¤§è¿›æ­¥ç©ºé—´å‘¢ï¼åˆ«ç°å¿ƒï¼Œä¸‹å±€ç¿»èº«ï¼",
      "è¿™å±€æœ‰ç‚¹å°å¤±åˆ©ï¼Œä½†å’±ä»¬å›å¤´æ˜¯å²¸ï¼Œç»§ç»­åŠ æ²¹ï¼",
      "ç¼˜åˆ†è®©æˆ‘ä»¬ç›¸èšï¼Œä¸‹å±€å’±ä»¬å°±æ¥ä¸ªå¤§åè½¬å§ï¼",
      "å¾—åˆ†æœ‰ç‚¹å°´å°¬ï¼Ÿæ²¡å…³ç³»ï¼Œä¸‹ä¸€å±€å’±ä»¬é€†å¤©æ”¹å‘½ï¼",
      "è¿™åˆ†æ•°...å—¯ï¼Œé¼“åŠ±ä½ ç»§ç»­åŠªåŠ›çš„è¯æ˜ï¼åŠ æ²¹ï¼",
      "è¯´å¥½çš„é€†è¢­å‘¢ï¼Ÿè¿™å°±å¼€å§‹å§ï¼Œä¿æŒå‹‡æ°”ï¼Œç»§ç»­è¿½ï¼",
      "ä¸‹é™å·²è§¦ï¼Œåé¢åªèƒ½å¾€ä¸Šé£™ï¼å‹‡æ•¢å‘å‰ï¼Œå†²ï¼",
      "è¿™å±€æœ‰ç‚¹æƒ¨ï¼Œä½†ä¹Ÿæ„å‘³ç€ä¸‹å±€æœ‰æ— é™å¯èƒ½æ€§å“¦ï¼",
      "å¾—åˆ†æœ‰ç‚¹è´Ÿï¼Œä½†ä½ çš„çƒ­æƒ…æ°¸è¿œæ­£ï¼ç»§ç»­åŠ æ²¹ï¼",
      "è¿™ä¸ªåˆ†æ•°...åªæ˜¯ä½ çš„å¼€å±€åŠ¨ç”»ï¼ŒçœŸæˆè¿˜åœ¨åå¤´ï¼",
      "åˆ«çœ‹ç°åœ¨åˆ†ä½ï¼Œæ½œåŠ›è‚¡éƒ½æ˜¯è¿™æ ·å¼€å§‹çš„ï¼",
      "åˆ†æ•°æ˜¯æš‚æ—¶çš„ï¼Œä½ çš„æ¯…åŠ›æ˜¯æ°¸æ’çš„ï¼å†²å•Šï¼",
      "æ²¡äº‹å„¿ï¼è¿™å«æ¬²æ‰¬å…ˆæŠ‘ï¼Œä¸‹å±€æƒŠè‰³å…¨åœºï¼",
      "è¿™åˆ†æ•°æœ‰ç‚¹å®³ç¾ï¼Œä¸è¿‡ä¸‹å±€å®ƒå°±å¼€æœ—äº†ï¼",
      "å“ˆå“ˆï¼Œè¿™å±€è®©ä½ ä½“éªŒä¸€æŠŠè°·åº•çš„æ„Ÿè§‰ï¼Œå‡†å¤‡åå¼¹ï¼",
      "åˆ†æ•°è™½è´Ÿï¼Œæ–—å¿—ä¸ç­ï¼ç»§ç»­å‰è¿›å§ï¼",
      "è¿™ç®—æ˜¯çƒ­èº«å±€ï¼ŒçœŸæ­£çš„å®åŠ›é©¬ä¸Šå±•ç°ï¼",
      "åˆ«æ…Œï¼å¤§å™¨æ™šæˆè¯´çš„å°±æ˜¯ä½ ï¼",
      "åˆ†æ•°æœ‰ç‚¹å®³ç¾åœ°èº²èµ·æ¥äº†ï¼Œä¸‹å±€è®©å®ƒå‡ºæ¥ï¼",
      "è¿™å±€åªæ˜¯å°æ’æ›²ï¼Œç²¾å½©çš„è¿˜åœ¨åé¢ï¼",
      "è´Ÿåˆ†ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯æ”¾å¼ƒï¼åŠ æ²¹ï¼",
      "è¿™åˆ†æ•°...å°±å½“æ˜¯ä¹°ä¸ªæ•™è®­ï¼Œä¸‹å±€èµšå›æ¥ï¼",
      "æš‚æ—¶çš„ä½è°·æ˜¯ä¸ºäº†æ›´é«˜çš„é£è·ƒï¼",
      "åˆ†æ•°ä½è¿·ï¼Œä½†ä½ çš„å‹‡æ°”å€¼çˆ†è¡¨ï¼ç»§ç»­ï¼",
      "è¿™å±€ç®—æ˜¯äº¤å­¦è´¹äº†ï¼Œä¸‹å±€å¿…å®šä¸°æ”¶ï¼",
      "åˆ«çœ‹è´Ÿåˆ†ï¼Œä½ çš„æ­£èƒ½é‡æ»¡æ ¼ï¼å†²é¸­ï¼",
      "è¿™åˆ†æ•°æœ‰ç‚¹çš®ï¼Œä¸‹å±€è®©å®ƒè€å®ç‚¹ï¼",
      "ä½å¼€é«˜èµ°æ‰æ˜¯ç‹é“ï¼ç›¸ä¿¡è‡ªå·±ï¼",
      "åˆ†æ•°æš‚æ—¶æ‰é˜Ÿï¼Œä½†ä½ çš„å†³å¿ƒä¸å˜ï¼",
      "è¿™å«é“ºå«ï¼Œä¸‹ä¸€å±€æ‰æ˜¯é«˜æ½®ï¼",
      "è´Ÿåˆ†æ˜¯æš‚æ—¶çš„ï¼Œç¿»ç›˜æ˜¯å¿…ç„¶çš„ï¼",
      "è¿™å±€è®©åˆ†æ•°èº²ä¸€èº²ï¼Œä¸‹å±€è®©å®ƒæ— å¤„å¯é€ƒï¼",
      "åˆ«æ€¥ï¼å‡¤å‡°éƒ½è¦å…ˆæµ´ç«æ‰èƒ½é‡ç”Ÿï¼",
      "è¿™åˆ†æ•°åœ¨æµ‹è¯•ä½ çš„æŠ—å‹èƒ½åŠ›å‘¢ï¼",
      "æš‚æ—¶è½åä¸ç®—å•¥ï¼Œç»åœ°åå‡»æ‰åˆºæ¿€ï¼",
      "åˆ†æ•°è™½ä½ï¼Œå¿—æ°”çŠ¹åœ¨ï¼ä¸‹å±€è§çœŸç« ï¼",
      "è¿™å±€æƒå½“ç»ƒæ‰‹ï¼Œä¸‹å±€å¤§æ˜¾èº«æ‰‹ï¼",
      "è´Ÿåˆ†æ€•ä»€ä¹ˆï¼Ÿå‹‡æ°”æ‰æ˜¯æœ€å¤§çš„èµ„æœ¬ï¼",
      "è¿™åˆ†æ•°åªæ˜¯æš‚æ—¶å®¢ä¸²ä¸€ä¸‹ï¼Œé©¬ä¸Šæ¢ä¸»è§’ï¼",
      "ä½è°·æ˜¯ä¸ºäº†è®©ä½ çœ‹æ¸…å‰æ–¹çš„é«˜å³°ï¼",
      "åˆ†æ•°æœ‰ç‚¹è°ƒçš®ï¼Œä¸‹å±€å¥½å¥½ç®¡æ•™å®ƒï¼",
      "è¿™å«è“„åŠ›ï¼Œä¸‹ä¸€å±€çˆ†å‘çœ‹ä½ çš„ï¼",
      "åˆ«æ…Œï¼è‹±é›„æ€»æ˜¯æœ€åæ‰ç™»åœºçš„ï¼",
      "è´Ÿåˆ†æ˜¯æˆé•¿çš„å°è®°ï¼Œä¸‹å±€å°±è¦èœ•å˜ï¼",
      "è¿™å±€ç®—æ˜¯é¢„æ¼”ï¼Œæ­£å¼æ¼”å‡ºé©¬ä¸Šå¼€å§‹ï¼",
      "åˆ†æ•°æš‚æ—¶ç½¢å·¥ï¼Œä¸‹å±€è®©å®ƒåŠ ç­ï¼",
      "ä½å¼€æ˜¯ä¸ºäº†é«˜èµ°ï¼ç›¸ä¿¡é€†è½¬æ—¶åˆ»ï¼",
      "è¿™åˆ†æ•°åœ¨è€ƒéªŒä½ çš„å¿ƒæ€å‘¢ï¼ç¨³ä½ï¼",
      "æš‚æ—¶çš„è´Ÿæ•°æ˜¯ä¸ºäº†æ›´å¤§çš„æ­£æ•°ï¼",
      "åˆ«æ€•ï¼å±±é‡æ°´å¤ç–‘æ— è·¯ï¼ŒæŸ³æš—èŠ±æ˜åœ¨ä¸‹å±€ï¼"
    ];

    // éšæœºè·å–æ–‡å­—ï¼ˆç¡®ä¿æ¯æ¬¡ä¸é‡å¤ï¼‰
    var lastUsedMessages = {};
    function getRandomMessage(type, playerIndex) {
      var messages;
      if (type === 'winner') {
        messages = winnerMessages;
      } else if (type === 'mid-high') {
        messages = midHighMessages;
      } else if (type === 'mid-low') {
        messages = midLowMessages;
      } else {
        messages = loserMessages;
      }
      
      var key = type + '_' + playerIndex;
      
      // åˆå§‹åŒ–è¯¥ç©å®¶çš„å·²ä½¿ç”¨æ¶ˆæ¯è®°å½•
      if (!lastUsedMessages[key]) {
        lastUsedMessages[key] = [];
      }
      
      // å¦‚æœæ‰€æœ‰æ¶ˆæ¯éƒ½ç”¨è¿‡äº†ï¼Œæ¸…ç©ºè®°å½•é‡æ–°å¼€å§‹
      if (lastUsedMessages[key].length >= messages.length) {
        lastUsedMessages[key] = [];
      }
      
      // è·å–æœªä½¿ç”¨çš„æ¶ˆæ¯
      var availableMessages = messages.filter(function(msg, idx) {
        return lastUsedMessages[key].indexOf(idx) === -1;
      });
      
      // éšæœºé€‰æ‹©ä¸€æ¡
      var randomMsg = availableMessages[Math.floor(Math.random() * availableMessages.length)];
      var msgIndex = messages.indexOf(randomMsg);
      lastUsedMessages[key].push(msgIndex);
      
      return randomMsg;
    }

    // æ˜¾ç¤ºå½©è›‹æ¨¡æ€æ¡†
    function showEggModal(playerName, type, playerIndex) {
      var modal = document.getElementById('eggModal');
      var nameDiv = document.getElementById('eggPlayerName');
      var charDiv = document.getElementById('dancingChar');
      var msgDiv = document.getElementById('eggMessage');
      
      nameDiv.textContent = playerName;
      
      var message = '';
      // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„è¡¨æƒ…å’Œæ¶ˆæ¯
      if (type === 'winner') {
        var chars = ['ğŸ‰', 'ğŸ†', 'ğŸ‘‘', 'â­', 'ğŸŠ', 'ğŸ¥‡', 'ğŸ’ª', 'ğŸ”¥'];
        charDiv.textContent = chars[Math.floor(Math.random() * chars.length)];
        message = getRandomMessage('winner', playerIndex);
        msgDiv.textContent = message;
      } else if (type === 'mid-high') {
        var chars = ['ğŸ“ˆ', 'ğŸš€', 'ğŸ’¯', 'âš¡', 'ğŸ‘', 'ğŸ¯', 'ğŸ’ª', 'ğŸ”¥'];
        charDiv.textContent = chars[Math.floor(Math.random() * chars.length)];
        message = getRandomMessage('mid-high', playerIndex);
        msgDiv.textContent = message;
      } else if (type === 'mid-low') {
        var chars = ['ğŸ’ª', 'ğŸ”¥', 'âš¡', 'ğŸš€', 'ğŸ’¯', 'ğŸ‘Š', 'ğŸ¯', 'ğŸ˜„'];
        charDiv.textContent = chars[Math.floor(Math.random() * chars.length)];
        message = getRandomMessage('mid-low', playerIndex);
        msgDiv.textContent = message;
      } else {
        var chars2 = ['ğŸ’ª', 'ğŸ”¥', 'âš¡', 'ğŸš€', 'ğŸ’¯', 'ğŸ‘Š', 'ğŸ¯', 'âš”ï¸'];
        charDiv.textContent = chars2[Math.floor(Math.random() * chars2.length)];
        message = getRandomMessage('loser', playerIndex);
        msgDiv.textContent = message;
      }
      
      modal.style.display = 'flex';
      
      // æ·»åŠ äº”å½©çº¸å±‘æ•ˆæœï¼ˆä»…èƒœåˆ©è€…ï¼‰
      if (type === 'winner') {
        createConfetti();
      }
      
      // æ’­æŠ¥å½©è›‹æ–‡å­—å†…å®¹ï¼ˆåªåœ¨è‡ªåŠ¨æ’­æ”¾å¼€å¯æ—¶ï¼‰
      if (autoPlayEnabled) {
        var speakMessage = playerName + "ï¼Œ" + message;
        speakText(speakMessage, 0.85, 1.08);
      }
    }

    // å…³é—­å½©è›‹æ¨¡æ€æ¡†
    function closeEggModal(event) {
      if (event && event.target.className !== 'egg-modal') return;
      var modal = document.getElementById('eggModal');
      modal.style.display = 'none';
      // æ¸…é™¤çº¸å±‘
      var confettis = document.querySelectorAll('.confetti');
      confettis.forEach(function(c) { c.remove(); });
    }

    // åˆ›å»ºäº”å½©çº¸å±‘æ•ˆæœ
    function createConfetti() {
      var modal = document.getElementById('eggModal');
      var colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500'];
      
      for (var i = 0; i < 30; i++) {
        (function(index) {
          setTimeout(function() {
            var confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + 's';
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            modal.appendChild(confetti);
            
            setTimeout(function() { confetti.remove(); }, 5000);
          }, index * 100);
        })(i);
      }
    }

    var trendVisible = [];
    var showAllHistory = false;
    function initStateArrays() {
      scoreConfirmed = [];
      scoreValues = [];
      totalScores = [];
      scoreInputLocked = [];
      allConfirmIndex = null;

      for (var i = 0; i < playerCount; i++) {
        scoreConfirmed.push(false);
        scoreValues.push(0);
        totalScores.push(0);
        scoreInputLocked.push(false);
      }

      trendVisible = [];
      for (var j = 0; j < playerCount; j++) {
        trendVisible.push(true);
      }
    }

    // ===== åå­—å°±ç»ªé—¨ç¦ï¼šæ‰€æœ‰äººåå­—æœªé½åˆ™ç¦æ­¢ä»»ä½•åˆ†æ•°è¾“å…¥ =====
    function areAllNamesReady() {
      var missing = [];
      for (var i = 0; i < playerCount; i++) {
        var name = (nameInputs[i] && nameInputs[i].value) ? nameInputs[i].value.trim() : "";
        if (!name) missing.push(i);
      }
      return { ok: missing.length === 0, missing: missing };
    }

    function highlightMissingNames(indices) {
      for (var i = 0; i < indices.length; i++) {
        highlightNameSelect(indices[i], "è¯·å…ˆé€‰æ‹©/è¾“å…¥æ‰€æœ‰ç©å®¶åå­—");
      }
      // é¡¶éƒ¨æç¤ºæ¡ï¼ˆæ›´æ˜æ˜¾ï¼‰
      showNameGateBanner();
      // èšç„¦åˆ°ç¬¬ä¸€ä¸ªç¼ºå¤±é¡¹ï¼Œå‡å°‘â€œæˆ‘è¯¥ç‚¹å“ªé‡Œâ€çš„å›°æƒ‘
      if (indices.length > 0 && nameSelects[indices[0]]) {
        try { nameSelects[indices[0]].focus(); } catch(e) {}
      }
    }

    function showNameGateBanner() {
      var banner = document.getElementById("nameGateBanner");
      if (!banner) return;
      banner.style.display = "block";
      banner.classList.remove("pulse");
      void banner.offsetWidth;
      banner.classList.add("pulse");
      // å°½é‡è®©æç¤ºæ¡ä¿æŒå¯è§ï¼ˆä¸å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼‰
      var rect = banner.getBoundingClientRect();
      if (rect.top < 0 || rect.top > window.innerHeight) {
        banner.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    }

    function hideNameGateBanner() {
      var banner = document.getElementById("nameGateBanner");
      if (!banner) return;
      banner.style.display = "none";
    }

    function updateScoreInputsEnabledUI() {
      // åªè¦åå­—æœªé½ -> æ‰€æœ‰äººåˆ†æ•°æ¡†ç¦ç”¨å¤–è§‚ï¼ˆä½†ä»æ˜¯ readOnlyï¼Œæˆ‘ä»¬é€šè¿‡ openKeypad é—¨ç¦æ‹¦æˆªï¼‰
      var ready = areAllNamesReady().ok;
      for (var i = 0; i < scoreInputs.length; i++) {
        if (!scoreInputs[i]) continue;
        if (ready) scoreInputs[i].classList.remove("score-input-disabled");
        else scoreInputs[i].classList.add("score-input-disabled");
      }
      if (ready) hideNameGateBanner();
      else showNameGateBanner();
    }
    function getUsedNames(exceptIndex) {
      var used = {};
      for (var i = 0; i < nameSelects.length; i++) {
        if (i === exceptIndex) continue;
        var v = (nameSelects[i].value || "").trim();
        if (!v) continue;
        if (v === "__custom__") continue;
        used[v] = true;
      }
      return used;
    }

    function updateNameOptions() {
      for (var j = 0; j < nameSelects.length; j++) {
        var sel = nameSelects[j];
        var current = (sel.value || "").trim();
        var used = getUsedNames(j);

        sel.innerHTML = "";

        var optEmpty = document.createElement("option");
        optEmpty.value = "";
        optEmpty.textContent = "é€‰æ‹©ç©å®¶â€¦";
        sel.appendChild(optEmpty);

        if (current) {
          var optCur = document.createElement("option");
          optCur.value = current;
          optCur.textContent = current;
          sel.appendChild(optCur);
        }

        for (var k = 0; k < defaultNames.length; k++) {
          var name = defaultNames[k];
          if (name === current) continue;
          if (used[name]) continue;

          var opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }

        var optCustom = document.createElement("option");
        optCustom.value = "__custom__";
        optCustom.textContent = "è‡ªå®šä¹‰â€¦";
        sel.appendChild(optCustom);

        sel.value = current || "";
      }
    }

    function showNameHint(index, msg) {
      var hint = nameHints[index];
      if (!hint) return;
      hint.textContent = msg || "è¯·é€‰æ‹©ç©å®¶å";
      hint.style.display = "block";
    }

    function hideNameHint(index) {
      var hint = nameHints[index];
      if (!hint) return;
      hint.style.display = "none";
    }

    function clearSelectAttention(index) {
      var sel = nameSelects[index];
      if (!sel) return;
      sel.classList.remove("attention");
      hideNameHint(index);
    }

    function highlightNameSelect(index, msg) {
      var sel = nameSelects[index];
      if (!sel) return;

      // âœ… å¢å¼º #1ï¼šåªè¦ç”¨æˆ·å‡†å¤‡æ“ä½œï¼ˆfocus/mousedown/changeï¼‰å°±æ¸…é™¤æç¤ºï¼ˆåœ¨ç›‘å¬å™¨é‡Œåšï¼‰
      sel.classList.remove("attention");
      void sel.offsetWidth; // reflow to retrigger animation
      sel.classList.add("attention");

      // âœ… å¢å¼º #2ï¼šæ˜¾ç¤ºæç¤ºæ–‡å­—
      showNameHint(index, msg || "è¯·å…ˆé€‰æ‹©ç©å®¶åï¼ˆå¯é€‰é¢„è®¾æˆ–è‡ªå®šä¹‰ï¼‰");

      sel.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function pulseAutoFillScore(index) {
      var inp = scoreInputs[index];
      if (!inp) return;
      inp.classList.remove("score-autofill");
      void inp.offsetWidth;
      inp.classList.add("score-autofill");
      setTimeout(function() {
        inp.classList.remove("score-autofill");
      }, 450);
    }

    function buildPlayersUI() {
      var row = document.getElementById("playersRow");
      row.innerHTML = "";
      nameInputs = [];
      nameSelects = [];
      nameHints = [];
      scoreInputs = [];
      confirmButtons = [];

      for (var i = 0; i < playerCount; i++) {
        (function(index) {
          var col = document.createElement("div");
          col.className = "player-col";

          var sel = document.createElement("select");
          sel.className = "name-select";
          col.appendChild(sel);

          // âœ… å¢å¼º #2ï¼šå°æç¤ºå ä½ï¼ˆé»˜è®¤éšè—ï¼‰
          var hint = document.createElement("div");
          hint.className = "name-hint";
          hint.textContent = "è¯·é€‰æ‹©ç©å®¶å";
          col.appendChild(hint);

          var nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.className = "name-input";
          col.appendChild(nameInput);

          var scoreRow = document.createElement("div");
          scoreRow.className = "score-row";

          var scoreInput = document.createElement("input");
          scoreInput.type = "text";
          scoreInput.className = "score-input";
          scoreInput.placeholder = "0";
          scoreInput.readOnly = true;
          scoreInput.onclick = function() { openKeypad(index); };
          scoreRow.appendChild(scoreInput);
          col.appendChild(scoreRow);

          var btnConfirm = document.createElement("button");
          btnConfirm.textContent = "ç¡®å®š";
          btnConfirm.onclick = function() { confirmPlayer(index); };
          col.appendChild(btnConfirm);

          row.appendChild(col);

          nameInputs.push(nameInput);
          nameSelects.push(sel);
          nameHints.push(hint);
          scoreInputs.push(scoreInput);
          confirmButtons.push(btnConfirm);

          // âœ… å¢å¼º #1ï¼šç”¨æˆ·ä¸€ç¢°ä¸‹æ‹‰æ¡†å°±æ¸…ç†è“è‰²æç¤º/æŠ–åŠ¨/æ–‡å­—
          sel.addEventListener("focus", function() { clearSelectAttention(index); });
          sel.addEventListener("mousedown", function() { clearSelectAttention(index); });
          sel.addEventListener("click", function() { clearSelectAttention(index); });

          sel.onchange = function() {
            clearSelectAttention(index);

            var v = (sel.value || "").trim();

            if (v === "__custom__") {
              var custom = prompt("è¯·è¾“å…¥ç©å®¶åå­—ï¼š", "");
              if (custom == null) {
                sel.value = "";
                nameInput.value = "";
                updateNameOptions();
                buildTrendLegend();
                return;
              }
              custom = String(custom).trim();
              if (!custom) {
                sel.value = "";
                nameInput.value = "";
                updateNameOptions();
                buildTrendLegend();
                return;
              }

              var used = getUsedNames(index);
              if (used[custom]) {
                alert("åå­—ã€Œ" + custom + "ã€å·²è¢«å…¶ä»–ç©å®¶é€‰æ‹©ï¼Œè¯·æ¢ä¸€ä¸ªã€‚");
                sel.value = "";
                nameInput.value = "";
                updateNameOptions();
                buildTrendLegend();
                return;
              }

              // å°†è‡ªå®šä¹‰åå­—å†™å…¥å½“å‰ç©å®¶
              var opt = document.createElement("option");
              opt.value = custom;
              opt.textContent = custom;
              sel.insertBefore(opt, sel.options[1] || null);

              sel.value = custom;
              nameInput.value = custom;

              updateNameOptions();
              sel.value = custom;
            } else {
              nameInput.value = v;
              updateNameOptions();
            }

            buildTrendLegend();
            refreshInputLockState();
            updateScoreInputsEnabledUI();
          };
        })(i);
      }

      updateNameOptions();
      refreshInputLockState();
      buildTrendLegend();
      updateScoreInputsEnabledUI();
    }

    function buildHistoryHeaderFooter() {
      var headerRow = document.getElementById("historyHeaderRow");
      var tbody = document.getElementById("historyBody");
      headerRow.innerHTML = "";
      tbody.innerHTML = "";

      var thRound = document.createElement("th");
      thRound.textContent = "å±€";
      headerRow.appendChild(thRound);

      var thTime = document.createElement("th");
      thTime.textContent = "æ—¶é—´";
      headerRow.appendChild(thTime);

      for (var i = 0; i < playerCount; i++) {
        var th = document.createElement("th");
        th.id = "h" + (i + 1);
        th.textContent = "ç©å®¶" + (i + 1);
        headerRow.appendChild(th);
      }

      var thEdit = document.createElement("th");
      thEdit.textContent = "ä¿®æ”¹";
      headerRow.appendChild(thEdit);

      var thDel = document.createElement("th");
      thDel.textContent = "åˆ é™¤";
      headerRow.appendChild(thDel);

      renderHistoryTable();
    }

    function updateHistoryToggleButton() {
      var btn = document.getElementById("historyToggleBtn");
      if (!btn) return;
      if (historyData.length > 10) {
        btn.style.display = "inline-block";
        btn.textContent = showAllHistory ? "åªçœ‹æœ€è¿‘10å±€" : "æŸ¥çœ‹å…¨éƒ¨";
      } else {
        btn.style.display = "none";
      }
    }

    function toggleHistoryView() {
      showAllHistory = !showAllHistory;
      renderHistoryTable();
    }

    function applyHistoryScoreClass(td, val) {
      td.classList.remove("history-score-pos", "history-score-neg", "history-score-zero");
      if (val > 0) td.classList.add("history-score-pos");
      else if (val < 0) td.classList.add("history-score-neg");
      else td.classList.add("history-score-zero");
    }

    function renderHistoryTable() {
      var tbody = document.getElementById("historyBody");
      if (!tbody) return;
      tbody.innerHTML = "";

      var summaryRow = document.createElement("tr");
      summaryRow.id = "summaryRow";

      var tdLabel = document.createElement("td");
      tdLabel.textContent = "æ€»è®¡";
      summaryRow.appendChild(tdLabel);

      var tdTime = document.createElement("td");
      tdTime.textContent = "â€”";
      summaryRow.appendChild(tdTime);

      for (var j = 0; j < playerCount; j++) {
        var td = document.createElement("td");
        td.id = "t" + (j + 1);
        var v = Number(totalScores[j] || 0);
        td.textContent = v;
        applyHistoryScoreClass(td, v);
        summaryRow.appendChild(td);
      }

      summaryRow.appendChild(document.createElement("td"));
      summaryRow.appendChild(document.createElement("td"));
      tbody.appendChild(summaryRow);

      var totalRounds = historyData.length;
      var startIndex = 0;
      if (!showAllHistory && totalRounds > 10) startIndex = totalRounds - 10;

      for (var i = totalRounds - 1; i >= startIndex; i--) {
        (function(idx) {
          var tr = document.createElement("tr");

          var tdRound = document.createElement("td");
          tdRound.textContent = (idx + 1);
          tr.appendChild(tdRound);

          var tdTime2 = document.createElement("td");
          tdTime2.textContent = historyTimes[idx] || "";
          tr.appendChild(tdTime2);

          var scores = historyData[idx];
          for (var p = 0; p < playerCount; p++) {
            var tdScore = document.createElement("td");
            var val = Number((scores && scores[p] != null) ? scores[p] : 0);
            tdScore.textContent = val;
            applyHistoryScoreClass(tdScore, val);
            tr.appendChild(tdScore);
          }

          var tdEdit = document.createElement("td");
          var btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.textContent = "ä¿®æ”¹";
          btnEdit.className = "table-action-btn";
          btnEdit.onclick = function() { editRound(idx); };
          tdEdit.appendChild(btnEdit);
          tr.appendChild(tdEdit);

          var tdDel = document.createElement("td");
          var btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.textContent = "åˆ é™¤";
          btnDel.className = "table-action-btn";
          btnDel.onclick = function() { deleteRound(idx); };
          tdDel.appendChild(btnDel);
          tr.appendChild(tdDel);

          tbody.appendChild(tr);
        })(i);
      }

      updateHistoryToggleButton();
    }

    function recalcTotalsFromHistory() {
      for (var i = 0; i < playerCount; i++) totalScores[i] = 0;
      for (var r = 0; r < historyData.length; r++) {
        var scores = historyData[r];
        if (!scores) continue;
        for (var j = 0; j < playerCount; j++) totalScores[j] += Number(scores[j] || 0);
      }
    }

    function hasHistory() { return historyData.length > 0; }
    function anyConfirmed() {
      for (var i = 0; i < scoreConfirmed.length; i++) if (scoreConfirmed[i]) return true;
      return false;
    }

    function refreshInputLockState(changedIndex) {
      if (!scoreInputs || scoreInputs.length === 0) return;

      // reset non-confirmed
      for (var i = 0; i < playerCount; i++) {
        if (!scoreConfirmed[i]) {
          scoreInputLocked[i] = false;
          if (scoreInputs[i]) scoreInputs[i].classList.remove("score-input-locked");
          if (confirmButtons[i]) {
            confirmButtons[i].disabled = false;
            confirmButtons[i].textContent = "ç¡®å®š";
            confirmButtons[i].classList.remove("btn-soft"); // reset soft style
          }
        }
      }
      allConfirmIndex = null;

      var filledCount = 0;
      var emptyIndices = [];
      for (var k = 0; k < playerCount; k++) {
        var v = (scoreInputs[k] && scoreInputs[k].value != null) ? scoreInputs[k].value.trim() : "";
        if (v !== "") filledCount++;
        else emptyIndices.push(k);
      }

      if (playerCount >= 2 && filledCount >= playerCount - 1 && emptyIndices.length === 1) {
        var lockedIdx = emptyIndices[0];

        if (!scoreConfirmed[lockedIdx]) {
          scoreInputLocked[lockedIdx] = true;
          if (scoreInputs[lockedIdx]) scoreInputs[lockedIdx].classList.add("score-input-locked");
          if (confirmButtons[lockedIdx]) confirmButtons[lockedIdx].disabled = true;
        }

        var candidate = null;
        if (typeof changedIndex === "number" &&
            changedIndex >= 0 && changedIndex < playerCount &&
            !scoreConfirmed[changedIndex]) {
          var cv = (scoreInputs[changedIndex] && scoreInputs[changedIndex].value != null)
            ? scoreInputs[changedIndex].value.trim() : "";
          if (cv !== "" && changedIndex !== lockedIdx) candidate = changedIndex;
        }

        if (candidate !== null && confirmButtons[candidate]) {
          allConfirmIndex = candidate;
          confirmButtons[candidate].textContent = "ç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰";

          // âœ… å¢å¼º #4ï¼šå¦‚æœæœ€åä¸€ä¸ªç©å®¶æ²¡é€‰åå­—ï¼Œåˆ™â€œç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰â€åŠé€æ˜ä½†å¯ç‚¹
          var lastName = (nameInputs[lockedIdx] && nameInputs[lockedIdx].value) ? nameInputs[lockedIdx].value.trim() : "";
          if (!lastName) confirmButtons[candidate].classList.add("btn-soft");
          else confirmButtons[candidate].classList.remove("btn-soft");
        }
      }
    }

    function changePlayerCount(delta) {
      var newCount = playerCount + delta;
      if (newCount < 2 || newCount > 8) {
        alert("ç©å®¶äººæ•°å¿…é¡»åœ¨ 2 åˆ° 8 äººä¹‹é—´ã€‚");
        return;
      }
      if (roundNumber > 0 || hasHistory() || anyConfirmed()) {
        alert("å¦‚éœ€æ›´æ”¹ç©å®¶äººæ•°ï¼Œè¯·å…ˆç‚¹å‡»ã€Œé‡ç½®æ•´åœºã€ã€‚");
        return;
      }

      playerCount = newCount;
      document.getElementById("playerCountText").textContent = playerCount;

      initStateArrays();
      buildPlayersUI();
      buildHistoryHeaderFooter();
      updateFooterTotals();
      refreshInputLockState();
      updateScoreInputsEnabledUI();
      updateTotalsText();
      updateStatistics();
      resizeTrendCanvas();

      document.getElementById("sumText").innerHTML = "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
      document.getElementById("totalText").textContent = "å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰";
    }

    function confirmPlayer(i) {
      if (!confirmButtons[i]) return;

      if (confirmButtons[i].textContent === "ç¡®è®¤ï¼ˆå…¨éƒ¨ï¼‰") {
        confirmAllPlayers();
        return;
      }

      if (scoreConfirmed[i]) return;

      var rawName = nameInputs[i].value.trim();
      if (!rawName) {
        highlightNameSelect(i);
        return;
      }

      var sStr = scoreInputs[i].value;
      if (!sStr) {
        alert("è¯·å…ˆè¾“å…¥ã€Œ" + rawName + "ã€çš„åˆ†æ•°å†ç¡®å®šã€‚");
        return;
      }

      var s = Number(sStr);
      if (isNaN(s)) {
        alert("ç©å®¶ã€Œ" + rawName + "ã€çš„åˆ†æ•°å¿…é¡»æ˜¯æ•°å­—ã€‚");
        return;
      }

      if (nameSelects[i]) nameSelects[i].disabled = true;

      scoreConfirmed[i] = true;
      scoreValues[i] = s;

      scoreInputs[i].classList.remove("score-input-active");
      scoreInputs[i].classList.remove("score-input-locked");
      scoreInputs[i].className = "score-input confirmed";
      scoreInputLocked[i] = false;

      confirmButtons[i].disabled = true;
      confirmButtons[i].classList.remove("btn-soft");

      refreshInputLockState();
      updateRound();
    }

    function confirmAllPlayers() {
      // Phase 1: validate & compute only
      var sumOthers = 0;
      var lastIndex = -1;
      var toConfirm = [];

      for (var i = 0; i < playerCount; i++) {
        var vStr = (scoreInputs[i] && scoreInputs[i].value != null)
          ? scoreInputs[i].value.trim()
          : "";

        if (scoreConfirmed[i]) {
          sumOthers += Number(scoreValues[i] || 0);
          continue;
        }

        if (vStr === "") {
          lastIndex = i;
          continue;
        }

        var nm = (nameInputs[i] && nameInputs[i].value) ? nameInputs[i].value.trim() : "";
        if (!nm) {
          highlightNameSelect(i);
          return;
        }

        var v = Number(vStr);
        if (isNaN(v)) {
          alert("ç©å®¶ã€Œ" + nm + "ã€çš„åˆ†æ•°æ— æ•ˆã€‚");
          return;
        }

        toConfirm.push({ idx: i, val: v });
        sumOthers += v;
      }

      if (lastIndex !== -1) {
        var lastName = (nameInputs[lastIndex] && nameInputs[lastIndex].value)
          ? nameInputs[lastIndex].value.trim()
          : "";
        if (!lastName) {
          highlightNameSelect(lastIndex, "è¿˜å·®æœ€åä¸€æ­¥ï¼šè¯·é€‰æ‹©æœ€åä¸€ä½ç©å®¶å");
          return;
        }
      }

      // Phase 2: commit
      for (var a = 0; a < toConfirm.length; a++) {
        var item = toConfirm[a];
        var idx = item.idx;
        var v2 = item.val;

        scoreConfirmed[idx] = true;
        scoreValues[idx] = v2;

        if (nameSelects[idx]) nameSelects[idx].disabled = true;

        if (scoreInputs[idx]) {
          scoreInputs[idx].classList.remove("score-input-active");
          scoreInputs[idx].classList.remove("score-input-locked");
          scoreInputs[idx].className = "score-input confirmed";
        }
        scoreInputLocked[idx] = false;

        if (confirmButtons[idx]) {
          confirmButtons[idx].disabled = true;
          confirmButtons[idx].textContent = "ç¡®å®š";
          confirmButtons[idx].classList.remove("btn-soft");
        }
      }

      // auto fill last one
      if (lastIndex !== -1 && !scoreConfirmed[lastIndex]) {
        var autoValue = -sumOthers;
        scoreConfirmed[lastIndex] = true;
        scoreValues[lastIndex] = autoValue;

        if (scoreInputs[lastIndex]) {
          scoreInputs[lastIndex].value = String(autoValue);
          scoreInputs[lastIndex].classList.remove("score-input-active");
          scoreInputs[lastIndex].classList.remove("score-input-locked");
          scoreInputs[lastIndex].className = "score-input confirmed";
          pulseAutoFillScore(lastIndex); // âœ… å¢å¼º #3
        }
        scoreInputLocked[lastIndex] = false;

        if (nameSelects[lastIndex]) nameSelects[lastIndex].disabled = true;

        if (confirmButtons[lastIndex]) {
          confirmButtons[lastIndex].disabled = true;
          confirmButtons[lastIndex].textContent = "ç¡®å®š";
          confirmButtons[lastIndex].classList.remove("btn-soft");
        }
      }

      allConfirmIndex = null;
      refreshInputLockState();
      updateRound();
    }

    function updateRound() {
      var cnt = 0;
      var sum = 0;
      for (var i = 0; i < playerCount; i++) {
        if (scoreConfirmed[i]) {
          cnt++;
          sum += scoreValues[i];
        }
      }

      // å½“ N-1 å·²ç¡®è®¤ï¼Œè‡ªåŠ¨è¡¥æœ€åä¸€ä¸ªï¼ˆä½†å¦‚æœæœ€åä¸€ä¸ªåå­—æœªé€‰ -> ä»…æç¤ºï¼Œä¸æäº¤ï¼‰
      if (cnt === playerCount - 1) {
        var missing = -1;
        for (var j = 0; j < playerCount; j++) {
          if (!scoreConfirmed[j]) { missing = j; break; }
        }
        if (missing !== -1) {
          if (!nameInputs[missing].value.trim()) {
            highlightNameSelect(missing, "è¿˜å·®æœ€åä¸€æ­¥ï¼šè¯·é€‰æ‹©æœ€åä¸€ä½ç©å®¶å");
            document.getElementById("sumText").innerHTML =
              "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š" + cnt + "ï¼Œæœ¬å±€æ€»å’Œï¼š" + sum + "ï¼ˆè¯·å…ˆä¸ºæœ€åä¸€ä½ç©å®¶é€‰æ‹©åå­—ï¼‰";
            return;
          }

          var autoValue = -sum;
          scoreConfirmed[missing] = true;
          scoreValues[missing] = autoValue;

          scoreInputs[missing].value = String(autoValue);
          scoreInputs[missing].classList.remove("score-input-active");
          scoreInputs[missing].classList.remove("score-input-locked");
          scoreInputs[missing].className = "score-input confirmed";
          pulseAutoFillScore(missing); // âœ… å¢å¼º #3
          scoreInputLocked[missing] = false;

          if (confirmButtons[missing]) confirmButtons[missing].disabled = true;
          if (nameSelects[missing]) nameSelects[missing].disabled = true;

          cnt = playerCount;
          sum = 0;
        }
      }

      document.getElementById("sumText").innerHTML =
        "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š" + cnt + "ï¼Œæœ¬å±€æ€»å’Œï¼š" + sum;
    }

    function saveRound() {
      for (var i = 0; i < playerCount; i++) {
        if (!nameInputs[i].value.trim()) {
          highlightNameSelect(i);
          return;
        }
        if (!scoreConfirmed[i]) {
          alert("å¿…é¡»æ‰€æœ‰ç©å®¶éƒ½ç¡®è®¤æœ¬å±€æ‰èƒ½ä¿å­˜");
          return;
        }
      }

      var currentScores = [];
      for (var j = 0; j < playerCount; j++) currentScores.push(scoreValues[j]);

      if (editingIndex !== null && editingIndex >= 0 && editingIndex < historyData.length) {
        historyData[editingIndex] = currentScores;
        historyTimes[editingIndex] = getCurrentTimestamp();
      } else {
        historyData.push(currentScores);
        historyTimes.push(getCurrentTimestamp());
      }

      editingIndex = null;
      roundNumber = historyData.length;

      recalcTotalsFromHistory();
      renderHistoryTable();
      updateTotalsText();
      updateNamesInHistoryHeader();
      updateFooterTotals();
      updateStatistics();
      resizeTrendCanvas();

      for (var k = 0; k < playerCount; k++) {
        scoreConfirmed[k] = false;
        scoreValues[k] = 0;
        scoreInputLocked[k] = false;

        if (scoreInputs[k]) {
          scoreInputs[k].value = "";
          scoreInputs[k].className = "score-input";
        }
        if (confirmButtons[k]) {
          confirmButtons[k].disabled = false;
          confirmButtons[k].textContent = "ç¡®å®š";
          confirmButtons[k].classList.remove("btn-soft");
        }
        if (nameSelects[k]) nameSelects[k].disabled = false;
      }

      allConfirmIndex = null;
      refreshInputLockState();
      updateScoreInputsEnabledUI();
      document.getElementById("sumText").innerHTML = "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
      
      // æ’­æŠ¥æœ¬è½®æˆç»©
      speakRoundScore(currentScores);
    }

    // ===== è¯­éŸ³æ’­æŠ¥åŠŸèƒ½ =====
    function speakText(text, rate, pitch, callback) {
      // åˆå§‹åŒ–è¯­éŸ³å¼•æ“ï¼ˆå¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼‰
      if (!selectedVoice && availableVoices.length === 0) {
        initVoices();
      }
      
      // ä¼˜åŒ–æ–‡æœ¬ä»¥è·å¾—æ›´è‡ªç„¶çš„æ’­æŠ¥æ•ˆæœ
      var optimizedText = optimizeTextForSpeech(text);
      
      var utterance = new SpeechSynthesisUtterance(optimizedText);
      utterance.lang = 'zh-CN';
      
      // ä½¿ç”¨é€‰å®šçš„æœ€ä½³è¯­éŸ³å¼•æ“
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // ä¼˜åŒ–è¯­éŸ³å‚æ•°ä»¥è·å¾—æ›´è‡ªç„¶çš„æ•ˆæœ
      // rate: 0.75-0.85 æ›´æ¥è¿‘è‡ªç„¶è¯­é€Ÿ
      // pitch: 1.0-1.1 ç¨å¾®æé«˜éŸ³è°ƒå¬èµ·æ¥æ›´æœ‰æ´»åŠ›
      utterance.rate = rate || 0.8;  // ç¨æ…¢çš„è¯­é€Ÿè®©äººæ›´å®¹æ˜“ç†è§£
      utterance.pitch = pitch || 1.05; // ç•¥å¾®æé«˜éŸ³è°ƒ
      utterance.volume = 1.0;
      
      utterance.onstart = function() {
        updateSpeechButton(true);
      };
      
      utterance.onend = function() {
        if (callback) {
          callback();
        } else {
          // å¦‚æœæ²¡æœ‰å›è°ƒï¼Œè¯´æ˜æ’­æŠ¥å·²ç»“æŸ
          updateSpeechButton(false);
        }
      };
      
      utterance.onerror = function(event) {
        console.log('è¯­éŸ³æ’­æŠ¥é”™è¯¯:', event);
        updateSpeechButton(false);
      };
      
      try {
        speechSynthesis.cancel(); // å–æ¶ˆä¹‹å‰çš„æ’­æŠ¥
        // å»¶è¿Ÿä¸€ç‚¹å†æ’­æ”¾ï¼Œç¡®ä¿cancelç”Ÿæ•ˆ
        setTimeout(function() {
          speechSynthesis.speak(utterance);
        }, 100);
      } catch(e) {
        console.log('è¯­éŸ³æ’­æŠ¥ä¸æ”¯æŒæˆ–å‡ºé”™:', e);
        updateSpeechButton(false);
      }
    }

    function speakRoundScore(currentScores) {
      // æ„å»ºæœ¬è½®å¾—åˆ†æ’­æŠ¥æ–‡æœ¬ï¼ˆæŒ‰ç©å®¶è®¾ç½®çš„è‡ªç„¶é¡ºåºï¼‰
      var roundText = "ç¬¬ " + roundNumber + " å±€ç»“æŸã€‚æœ¬è½®å¾—åˆ†ï¼š";
      for (var i = 0; i < playerCount; i++) {
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var score = currentScores[i];
        var scoreText = '';
        if (score > 0) {
          scoreText = "åŠ  " + score + " åˆ†";
        } else if (score < 0) {
          scoreText = "å‡ " + Math.abs(score) + " åˆ†";
        } else {
          scoreText = "é›¶åˆ†";
        }
        roundText += name + " " + scoreText;
        if (i < playerCount - 1) {
          roundText += "ï¼Œ";
        } else {
          roundText += "ã€‚";
        }
      }
      
      // æ„å»ºæ±‡æ€»åˆ†æ•°æ’­æŠ¥æ–‡æœ¬ï¼ˆæŒ‰ç´¯è®¡æ€»åˆ†ä»å¤§åˆ°å°æ’åºï¼‰
      var totalText = "ç›®å‰ç´¯è®¡æ€»åˆ†æ’åï¼š";
      var players = [];
      for (var j = 0; j < playerCount; j++) {
        var name2 = nameInputs[j].value.trim() || ("ç©å®¶" + (j + 1));
        var total = totalScores[j];
        players.push({ name: name2, total: total });
      }
      
      // æŒ‰ç´¯è®¡æ€»åˆ†ä»å¤§åˆ°å°æ’åºï¼ˆå®é™…æ€»åˆ†å€¼ï¼Œä¸æ˜¯ç»å¯¹å€¼ï¼‰
      players.sort(function(a, b) {
        return b.total - a.total;
      });
      
      for (var k = 0; k < players.length; k++) {
        var p = players[k];
        var totalText2 = '';
        if (p.total > 0) {
          totalText2 = "æ­£ " + p.total + " åˆ†";
        } else if (p.total < 0) {
          totalText2 = "è´Ÿ " + Math.abs(p.total) + " åˆ†";
        } else {
          totalText2 = "é›¶åˆ†";
        }
        totalText += p.name + " " + totalText2;
        if (k < players.length - 1) {
          totalText += "ï¼Œ";
        } else {
          totalText += "ã€‚";
        }
      }
      
      // å§‹ç»ˆä¿å­˜æœ¬æ¬¡æ’­æŠ¥æ–‡æœ¬ï¼Œç”¨äºæ‰‹åŠ¨æ’­æ”¾
      lastRoundText = roundText;
      lastTotalText = totalText;
      
      // å¦‚æœè‡ªåŠ¨æ’­æ”¾æœªå¼€å¯ï¼Œåˆ™åªä¿å­˜æ–‡æœ¬ä¸æ’­æŠ¥
      if (!autoPlayEnabled) {
        return;
      }
      
      // ç¬¬ä¸€æ­¥ï¼šæ’­æŠ¥æœ¬è½®å¾—åˆ†
      speakText(roundText, 0.8, 1.05, function() {
        // æ’­æŠ¥å®Œæœ¬è½®åï¼Œå»¶è¿Ÿåæ’­æŠ¥æ±‡æ€»åˆ†æ•°
        setTimeout(function() {
          speakText(totalText, 0.8, 1.05, function() {
            // æ‰€æœ‰æ’­æŠ¥ç»“æŸï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
            updateSpeechButton(false);
          });
        }, 800); // å¢åŠ åœé¡¿æ—¶é—´åˆ°800msï¼Œæ›´è‡ªç„¶
      });
    }

    // é‡æ–°æ’­æ”¾æœ€åä¸€æ¬¡çš„æ’­æŠ¥ç»“æœ
    function replayLastSpeech() {
      if (!lastRoundText || !lastTotalText) {
        alert("æš‚æ— æ’­æŠ¥è®°å½•ï¼Œè¯·å…ˆå®Œæˆä¸€å±€æ¸¸æˆã€‚");
        return;
      }
      speakText(lastRoundText, 0.8, 1.05, function() {
        setTimeout(function() {
          speakText(lastTotalText, 0.8, 1.05, function() {
            // æ‰€æœ‰æ’­æŠ¥ç»“æŸï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
            updateSpeechButton(false);
          });
        }, 800);
      });
    }

    function resetCurrentRound() {
      activeScoreIndex = null;
      allConfirmIndex = null;
      editingIndex = null;
      closeKeypad();

      for (var i = 0; i < playerCount; i++) {
        scoreConfirmed[i] = false;
        scoreValues[i] = 0;
        scoreInputLocked[i] = false;

        if (scoreInputs[i]) {
          scoreInputs[i].value = "";
          scoreInputs[i].className = "score-input";
        }
        if (confirmButtons[i]) {
          confirmButtons[i].disabled = false;
          confirmButtons[i].textContent = "ç¡®å®š";
          confirmButtons[i].classList.remove("btn-soft");
        }
        if (nameSelects[i]) nameSelects[i].disabled = false;

        clearSelectAttention(i);
      }

      refreshInputLockState();
      updateScoreInputsEnabledUI();
      document.getElementById("sumText").innerHTML = "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
    }

    function editRound(index) {
      if (index < 0 || index >= historyData.length) return;

      if (anyConfirmed()) {
        if (!confirm("å½“å‰å±€æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç»§ç»­æ“ä½œä¼šè¦†ç›–è¿™äº›è¾“å…¥ï¼Œç¡®å®šè¦ç»§ç»­ä¿®æ”¹ç¬¬ " + (index + 1) + " å±€å—ï¼Ÿ")) {
          return;
        }
      }

      editingIndex = index;
      var scores = historyData[index];

      for (var i = 0; i < playerCount; i++) {
        scoreConfirmed[i] = false;
        scoreValues[i] = 0;
        scoreInputLocked[i] = false;

        if (scoreInputs[i]) {
          scoreInputs[i].value = scores[i];
          scoreInputs[i].className = "score-input";
        }
        if (confirmButtons[i]) {
          confirmButtons[i].disabled = false;
          confirmButtons[i].textContent = "ç¡®å®š";
          confirmButtons[i].classList.remove("btn-soft");
        }
        if (nameSelects[i]) nameSelects[i].disabled = false;

        clearSelectAttention(i);
      }

      allConfirmIndex = null;
      refreshInputLockState();
      document.getElementById("sumText").innerHTML =
        "æ­£åœ¨ä¿®æ”¹ç¬¬ " + (index + 1) + " å±€ï¼Œè¯·é‡æ–°ä¸ºæ¯ä½ç©å®¶ç‚¹å‡»ã€Œç¡®å®šã€ï¼Œå†ç‚¹ã€Œä¿å­˜æœ¬å±€å¹¶å¼€å§‹ä¸‹ä¸€å±€ã€ã€‚";
    }

    function deleteRound(index) {
      if (index < 0 || index >= historyData.length) return;
      if (!confirm("ç¡®å®šè¦åˆ é™¤ç¬¬ " + (index + 1) + " å±€çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;

      historyData.splice(index, 1);
      historyTimes.splice(index, 1);
      roundNumber = historyData.length;

      if (editingIndex === index) editingIndex = null;
      else if (editingIndex !== null && editingIndex > index) editingIndex--;

      recalcTotalsFromHistory();
      renderHistoryTable();
      updateFooterTotals();
      updateTotalsText();
      updateStatistics();
      resizeTrendCanvas();
    }

    function updateTotalsText() {
      var totalDiv = document.getElementById("totalText");

      if (historyData.length === 0) {
        totalDiv.innerHTML = "å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰";
        return;
      }

      var players = [];
      for (var i = 0; i < playerCount; i++) {
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var score = totalScores[i] || 0;
        players.push({ index: i, name: name, score: score });
      }

      var max = Math.max.apply(null, totalScores);
      var min = Math.min.apply(null, totalScores);

      players.sort(function (a, b) {
        if (b.score !== a.score) return b.score - a.score;
        return a.index - b.index;
      });

      var html = '<div class="totals-title">å½“å‰æ€»åˆ†æ±‡æ€»ï¼ˆæŒ‰åˆ†æ•°ä»é«˜åˆ°ä½ï¼‰ï¼š</div>';
      html += '<div class="totals-row">';

      for (var j = 0; j < players.length; j++) {
        var p = players[j];
        var rank = j + 1;

        var rankCls = "rank-badge";
        var scoreCls = "player-score";

        if (p.score > 0) scoreCls += " player-score-positive";
        else if (p.score < 0) scoreCls += " player-score-negative";
        else scoreCls += " player-score-zero";

        var isLeader = (p.score === max && max !== 0);
        if (isLeader) { rankCls += " leader-rank"; scoreCls += " leader-score"; }

        var rankLabel = isLeader ? ("ğŸ‘‘" + rank) : ("#" + rank);

        // ä¸ºæ‰€æœ‰ç©å®¶æ·»åŠ å½©è›‹ï¼ˆæ ¹æ®æ’åå’Œå¾—åˆ†æƒ…å†µï¼‰
        var easterEgg = '';
        var isFirst = (p.score === max && max > 0);
        var isLast = (p.score === min && min < 0 && players.length > 1);
        var isMidHigh = (!isFirst && !isLast && p.score >= 0 && p.score !== max);
        var isMidLow = (!isFirst && !isLast && p.score < 0 && p.score !== min);
        
        if (isFirst) {
          easterEgg = '<span class="easter-egg" onclick="showEggModal(\'' + 
                      escapeHtml(p.name).replace(/'/g, "\\'") + '\', \'winner\', ' + p.index + ')" title="ç‚¹å‡»æŸ¥çœ‹æƒŠå–œï¼">ğŸ¥šâœ¨</span>';
        } else if (isLast) {
          easterEgg = '<span class="easter-egg" onclick="showEggModal(\'' + 
                      escapeHtml(p.name).replace(/'/g, "\\'") + '\', \'loser\', ' + p.index + ')" title="ç‚¹å‡»è·å–é¼“åŠ±ï¼">ğŸ¥šğŸ’ª</span>';
        } else if (isMidHigh) {
          easterEgg = '<span class="easter-egg" onclick="showEggModal(\'' + 
                      escapeHtml(p.name).replace(/'/g, "\\'") + '\', \'mid-high\', ' + p.index + ')" title="ç‚¹å‡»æŸ¥çœ‹è¯„ä»·ï¼">ğŸ¥šâ­</span>';
        } else if (isMidLow) {
          easterEgg = '<span class="easter-egg" onclick="showEggModal(\'' + 
                      escapeHtml(p.name).replace(/'/g, "\\'") + '\', \'mid-low\', ' + p.index + ')" title="ç‚¹å‡»è·å–é¼“åŠ±ï¼">ğŸ¥šğŸ”¥</span>';
        }

        html +=
          '<div class="total-item">' +
            '<span class="' + rankCls + '">' + rankLabel + '</span>' +
            '<span class="player-name">' + escapeHtml(p.name) + easterEgg + '</span>' +
            '<span class="' + scoreCls + '">' + p.score + '</span>' +
          '</div>';
      }

      html += '</div>';
      totalDiv.innerHTML = html;
    }

    function updateNamesInHistoryHeader() {
      for (var i = 0; i < playerCount; i++) {
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var cell = document.getElementById("h" + (i + 1));
        if (cell) cell.textContent = name;
      }
      buildTrendLegend();
    }

    function updateFooterTotals() {
      for (var i = 0; i < playerCount; i++) {
        var cell = document.getElementById("t" + (i + 1));
        if (!cell) continue;
        var v = Number(totalScores[i] || 0);
        cell.textContent = v;
        applyHistoryScoreClass(cell, v);
      }
    }

    function updateStatistics() {
      var winsDiv = document.getElementById("statsWinsList");
      var maxMinDiv = document.getElementById("statsMaxMin");
      var canvas = document.getElementById("statsPie");
      if (!winsDiv || !maxMinDiv || !canvas) return;
      var ctx = canvas.getContext("2d");

      if (historyData.length === 0) {
        winsDiv.innerHTML = "æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚";
        maxMinDiv.innerHTML = "æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰ã€‚";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }

      var wins = [];
      for (var i = 0; i < playerCount; i++) wins.push(0);

      var maxScore = null, maxPlayerIndex = null, maxRound = null;
      var minScore = null, minPlayerIndex = null, minRound = null;

      for (var r = 0; r < historyData.length; r++) {
        var scores = historyData[r];
        if (!scores) continue;
        for (var p = 0; p < playerCount; p++) {
          var val = Number(scores[p] || 0);
          if (val > 0) wins[p] += 1;
          if (maxScore === null || val > maxScore) { maxScore = val; maxPlayerIndex = p; maxRound = r; }
          if (minScore === null || val < minScore) { minScore = val; minPlayerIndex = p; minRound = r; }
        }
      }

      var totalWins = wins.reduce(function(a, b) { return a + b; }, 0);

      var players = [];
      for (var j = 0; j < playerCount; j++) {
        var name = nameInputs[j].value.trim() || ("ç©å®¶" + (j + 1));
        players.push({ index: j, name: name, wins: wins[j] });
      }

      players.sort(function(a, b) {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return a.index - b.index;
      });

      if (totalWins === 0) {
        winsDiv.innerHTML = "ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•ä¸€å±€ç©å®¶å¾—åˆ†ä¸ºæ­£ï¼Œç­‰å¾…æœ‰äººèµ¢ä¸€å±€å†æ¥çœ‹ç»Ÿè®¡å§ï½";
      } else {
        var listHtml = '<ul class="stats-list">';
        for (var k = 0; k < players.length; k++) {
          var pl = players[k];
          if (pl.wins === 0) continue;
          var rank = k + 1;
          var pct = totalWins > 0 ? (pl.wins * 100 / totalWins) : 0;
          listHtml += '<li>ç¬¬ ' + rank + ' åï¼š' + escapeHtml(pl.name) +
                      ' â€”â€” èµ¢äº† ' + pl.wins + ' æ¬¡ï¼ˆ' + pct.toFixed(1) + '%ï¼‰</li>';
        }
        listHtml += '</ul>';
        winsDiv.innerHTML = listHtml;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (totalWins > 0) {
        var cx = canvas.width / 2;
        var cy = canvas.height / 2;
        var radius = Math.min(cx, cy) - 10;
        var startAngle = 0;

        for (var m = 0; m < players.length; m++) {
          var pl2 = players[m];
          if (pl2.wins <= 0) continue;

          var sliceAngle = (pl2.wins / totalWins) * Math.PI * 2;
          var endAngle = startAngle + sliceAngle;

          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.arc(cx, cy, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fillStyle = pieColors[pl2.index % pieColors.length];
          ctx.fill();

          var pct2 = (pl2.wins * 100 / totalWins);
          var label = pl2.name + "ï¼Œ" + pct2.toFixed(1) + "%ï¼Œ" + pl2.wins + "æ¬¡";

          var midAngle = startAngle + sliceAngle / 2;
          var textRadius = radius * 0.6;
          var tx = cx + Math.cos(midAngle) * textRadius;
          var ty = cy + Math.sin(midAngle) * textRadius;

          ctx.fillStyle = "#111827";
          ctx.font = "10px -apple-system, system-ui";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(label, tx, ty);

          startAngle = endAngle;
        }
      }

      if (maxScore === null) {
        maxMinDiv.innerHTML = "å•æ¬¡æœ€é«˜å¾—åˆ†ï¼šæš‚æ— è®°å½•ã€‚<br>å•æ¬¡æœ€ä½å¾—åˆ†ï¼šæš‚æ— è®°å½•ã€‚";
      } else {
        var maxName = nameInputs[maxPlayerIndex].value.trim() || ("ç©å®¶" + (maxPlayerIndex + 1));
        var minName = nameInputs[minPlayerIndex].value.trim() || ("ç©å®¶" + (minPlayerIndex + 1));
        maxMinDiv.innerHTML =
          "å•æ¬¡æœ€é«˜å¾—åˆ†ï¼š<strong>" + escapeHtml(maxName) + "</strong> åœ¨ç¬¬ <strong>" + (maxRound+1) +
          "</strong> å±€ï¼Œå¾—åˆ† <strong>" + maxScore + "</strong>ã€‚<br>" +
          "å•æ¬¡æœ€ä½å¾—åˆ†ï¼š<strong>" + escapeHtml(minName) + "</strong> åœ¨ç¬¬ <strong>" + (minRound+1) +
          "</strong> å±€ï¼Œå¾—åˆ† <strong>" + minScore + "</strong>ã€‚";
      }
    }

    function buildTrendLegend() {
      var legend = document.getElementById("trendLegend");
      if (!legend) return;
      legend.innerHTML = "";

      for (var i = 0; i < playerCount; i++) {
        if (trendVisible[i] === undefined) trendVisible[i] = true;
        var name = nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1));
        var color = pieColors[i % pieColors.length];

        var label = document.createElement("label");
        label.className = "trend-legend-item";

        var cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = trendVisible[i];
        (function(idx) {
          cb.onchange = function() {
            trendVisible[idx] = this.checked;
            updateTrendChart();
          };
        })(i);

        var colorBox = document.createElement("span");
        colorBox.className = "trend-color-box";
        colorBox.style.backgroundColor = color;

        var textSpan = document.createElement("span");
        textSpan.textContent = name;

        label.appendChild(cb);
        label.appendChild(colorBox);
        label.appendChild(textSpan);
        legend.appendChild(label);
      }
    }

    function resizeTrendCanvas() {
      var canvas = document.getElementById("trendCanvas");
      if (!canvas) return;
      var parent = canvas.parentElement;
      if (!parent) return;

      var parentWidth = parent.clientWidth;
      if (parentWidth <= 0) return;

      canvas.width = parentWidth;
      canvas.height = 220;

      updateTrendChart();
    }

    function updateTrendChart() {
      var canvas = document.getElementById("trendCanvas");
      if (!canvas) return;
      var ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      var rounds = historyData.length;
      if (rounds === 0) {
        ctx.fillStyle = "#666";
        ctx.font = "12px -apple-system, BlinkMacSystemFont, system-ui";
        ctx.fillText("æš‚æ— æ•°æ®ï¼ˆè¯·å…ˆå®Œæˆè‡³å°‘ä¸€å±€ï¼‰", 20, 30);
        return;
      }

      var series = [];
      var minY = null;
      var maxY = null;

      for (var i = 0; i < playerCount; i++) {
        var arr = [];
        var sum = 0;
        for (var r = 0; r < rounds; r++) {
          sum += Number(historyData[r][i] || 0);
          arr.push(sum);
          if (minY === null || sum < minY) minY = sum;
          if (maxY === null || sum > maxY) maxY = sum;
        }
        series.push(arr);
      }

      if (minY === null || maxY === null) return;

      if (minY === maxY) {
        if (minY === 0) { minY = -10; maxY = 10; }
        else { var pad = Math.abs(minY) * 0.2; minY -= pad; maxY += pad; }
      } else {
        var span = maxY - minY;
        var pad2 = span * 0.1;
        minY -= pad2;
        maxY += pad2;
      }

      var paddingLeft = 40, paddingRight = 10, paddingTop = 20, paddingBottom = 30;
      var w = canvas.width, h = canvas.height;
      var plotW = w - paddingLeft - paddingRight;
      var plotH = h - paddingTop - paddingBottom;

      function xForRound(rIndex) {
        if (rounds === 1) return paddingLeft + plotW / 2;
        return paddingLeft + (plotW * (rIndex / (rounds - 1)));
      }
      function yForValue(v) {
        return paddingTop + (maxY - v) * plotH / (maxY - minY);
      }

      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop);
      ctx.lineTo(paddingLeft, paddingTop + plotH);
      ctx.lineTo(paddingLeft + plotW, paddingTop + plotH);
      ctx.stroke();

      ctx.fillStyle = "#555";
      ctx.font = "11px -apple-system, system-ui";

      for (var rr = 0; rr < rounds; rr++) {
        var x = xForRound(rr);
        var y = paddingTop + plotH;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x, y + 3);
        ctx.strokeStyle = "#ccc";
        ctx.stroke();

        if ((rr + 1) === 1 || (rr + 1) === rounds || (rounds <= 10)) {
          ctx.fillText((rr + 1), x - 4, y + 14);
        } else if ((rr + 1) % Math.ceil(rounds / 5) === 0) {
          ctx.fillText((rr + 1), x - 4, y + 14);
        }
      }

      var steps = 5;
      for (var t = 0; t <= steps; t++) {
        var value = minY + (maxY - minY) * (t / steps);
        var yy = yForValue(value);
        ctx.beginPath();
        ctx.moveTo(paddingLeft - 3, yy);
        ctx.lineTo(paddingLeft, yy);
        ctx.strokeStyle = "#ccc";
        ctx.stroke();
        ctx.fillText(value.toFixed(0), 2, yy + 3);
      }

      ctx.lineWidth = 2;
      for (var p = 0; p < playerCount; p++) {
        if (trendVisible[p] === false) continue;
        var data = series[p];
        if (!data || data.length === 0) continue;

        ctx.beginPath();
        for (var rIdx = 0; rIdx < rounds; rIdx++) {
          var xx = xForRound(rIdx);
          var yyy = yForValue(data[rIdx]);
          if (rIdx === 0) ctx.moveTo(xx, yyy);
          else ctx.lineTo(xx, yyy);
        }
        ctx.strokeStyle = pieColors[p % pieColors.length];
        ctx.stroke();
      }
    }

    function resetAll() {
      roundNumber = 0;
      historyData = [];
      historyTimes = [];
      editingIndex = null;
      activeScoreIndex = null;
      allConfirmIndex = null;
      showAllHistory = false;
      closeKeypad();

      initStateArrays();
      buildPlayersUI();
      buildHistoryHeaderFooter();
      updateFooterTotals();
      refreshInputLockState();
      updateScoreInputsEnabledUI();
      updateTotalsText();
      updateStatistics();
      resizeTrendCanvas();

      document.getElementById("playerCountText").textContent = playerCount;
      document.getElementById("sumText").innerHTML = "å½“å‰å·²ç¡®è®¤äººæ•°ï¼š0ï¼Œæœ¬å±€æ€»å’Œï¼š0";
      document.getElementById("totalText").textContent = "å½“å‰æ€»åˆ†æ±‡æ€»ï¼šæš‚æ— ï¼ˆè¯·å…ˆå®Œæˆä¸€å±€ï¼‰";
    }

    function exportCSV() {
      var rows = [];
      var header = ["å±€", "æ—¶é—´"];
      for (var i = 0; i < playerCount; i++) header.push(nameInputs[i].value.trim() || ("ç©å®¶" + (i + 1)));
      rows.push(header);

      var totalRow = ["æ€»è®¡", "â€”"];
      for (var j = 0; j < playerCount; j++) totalRow.push(totalScores[j] || 0);
      rows.push(totalRow);

      for (var r = 0; r < historyData.length; r++) {
        var row = [];
        row.push(r + 1);
        row.push(historyTimes[r] || "");
        var scores = historyData[r];
        for (var p = 0; p < playerCount; p++) row.push(scores[p]);
        rows.push(row);
      }

      function esc(v) {
        var s = String(v);
        if (s.indexOf('"') !== -1 || s.indexOf(',') !== -1 || s.indexOf('\n') !== -1) {
          s = '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      }
      var csvContent = rows.map(function(row) {
        return row.map(esc).join(",");
      }).join("\r\n");

      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      a.href = url;
      a.download = "scores.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ===== è‡ªå®šä¹‰æ•°å­—é”®ç›˜é€»è¾‘ =====
    
    function openKeypad(index) {
      // ğŸš¨ é—¨ç¦ï¼šä»»ä½•äººè¾“å…¥åˆ†æ•°å‰ï¼Œå¿…é¡»ä¿è¯æ‰€æœ‰ç©å®¶åå­—å·²å°±ç»ª
      var check = areAllNamesReady();
      if (!check.ok) {
        highlightMissingNames(check.missing);
        updateScoreInputsEnabledUI();
        return;
      }

      if (scoreConfirmed[index] || scoreInputLocked[index]) return;
      activeScoreIndex = index;

      for (var i = 0; i < scoreInputs.length; i++) scoreInputs[i].classList.remove("score-input-active");
      var input = scoreInputs[index];
      input.classList.add("score-input-active");

      var keypad = document.getElementById("customKeypad");
      keypad.style.display = "block";

      var rect = input.getBoundingClientRect();
      var scrollX = window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0;
      var scrollY = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;

      var left = rect.right + 8 + scrollX;
      var top = rect.top + scrollY;

      var kpWidth = keypad.offsetWidth;
      var kpHeight = keypad.offsetHeight;
      var viewportWidth = document.documentElement.clientWidth;
      var viewportHeight = document.documentElement.clientHeight;

      if (left + kpWidth > scrollX + viewportWidth - 8) {
        left = rect.left + scrollX - kpWidth - 8;
        if (left < scrollX + 4) left = scrollX + 4;
      }

      if (top + kpHeight > scrollY + viewportHeight - 8) {
        top = scrollY + viewportHeight - kpHeight - 8;
        if (top < scrollY + 4) top = scrollY + 4;
      }

      keypad.style.left = left + "px";
      keypad.style.top = top + "px";
    }


    function closeKeypad() {
      var keypad = document.getElementById("customKeypad");
      keypad.style.display = "none";
      for (var i = 0; i < scoreInputs.length; i++) scoreInputs[i].classList.remove("score-input-active");
      activeScoreIndex = null;
    }

    function keypadAppend(ch) {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;

      var inp = scoreInputs[activeScoreIndex];
      var v = inp.value || "";

      if (ch === '-') {
        if (v.startsWith("-")) v = v.slice(1);
        else v = "-" + v.replace(/-/g, "");
      } else {
        if (v === "" || v === "-") v = "-" + ch;
        else v = v + ch;
      }

      inp.value = v;
      refreshInputLockState(activeScoreIndex);
    }

    function keypadBackspace() {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      var inp = scoreInputs[activeScoreIndex];
      var v = inp.value || "";
      if (v.length > 0) v = v.slice(0, -1);
      inp.value = v;
      refreshInputLockState(activeScoreIndex);
    }

    function keypadClear() {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      scoreInputs[activeScoreIndex].value = "";
      refreshInputLockState(activeScoreIndex);
    }

    function toggleMinus() {
      if (activeScoreIndex === null) return;
      if (scoreConfirmed[activeScoreIndex] || scoreInputLocked[activeScoreIndex]) return;
      var inp = scoreInputs[activeScoreIndex];
      var v = inp.value || "";
      if (v.startsWith("-")) v = v.slice(1);
      else v = "-" + v.replace(/-/g, "");
      inp.value = v;
      refreshInputLockState(activeScoreIndex);
    }

    document.addEventListener("click", function(e) {
      var keypad = document.getElementById("customKeypad");
      var clickedOnKeypad = keypad.contains(e.target);
      var clickedOnScore = false;
      for (var i = 0; i < scoreInputs.length; i++) {
        if (scoreInputs[i] === e.target) { clickedOnScore = true; break; }
      }
      if (!clickedOnKeypad && !clickedOnScore) closeKeypad();
    });

    window.addEventListener("resize", resizeTrendCanvas);

    // åˆå§‹åŒ–è¯­éŸ³å¼•æ“
    if (typeof speechSynthesis !== 'undefined') {
      // è¯­éŸ³åˆ—è¡¨å¯èƒ½éœ€è¦æ—¶é—´åŠ è½½
      speechSynthesis.onvoiceschanged = function() {
        initVoices();
      };
      // ç«‹å³å°è¯•åˆå§‹åŒ–ä¸€æ¬¡
      initVoices();
    }

    // ===== é¡µé¢åˆå§‹åŒ– =====
    initStateArrays();
    buildPlayersUI();
    buildHistoryHeaderFooter();
    updateFooterTotals();
    refreshInputLockState();
    updateScoreInputsEnabledUI();
    updateTotalsText();
    updateStatistics();
    resizeTrendCanvas();
    document.getElementById("playerCountText").textContent = playerCount;
    
    // ä»localStorageåŠ è½½è‡ªåŠ¨æ’­æ”¾è®¾ç½®
    try {
      var savedAutoPlay = localStorage.getItem('scoreboard_autoplay');
      if (savedAutoPlay === '1') {
        autoPlayEnabled = true;
        var checkbox = document.getElementById('autoPlayCheckbox');
        if (checkbox) checkbox.checked = true;
      }
    } catch(e) {}
  </script>
</body>
</html>
